<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | GoPandaCars</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Add these inside the head section -->
<link rel="manifest" href="/manifest.json">
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-messaging-compat.js"></script>
  <style>
    .sidebar { 
      min-height: 100vh; 
      background-color: #f8f9fa; 
      position: sticky;
      top: 0;
    }
    .nav-link { color: #333; }
    .nav-link.active { 
      color: #0d6efd; 
      font-weight: 500;
      background-color: rgba(13, 110, 253, 0.1);
      border-radius: 5px;
    }
    .badge-status { font-size: 0.8rem; }
    .booking-card { transition: all 0.3s; }
    .booking-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .card-img-top { 
      height: 200px; 
      object-fit: cover;
      border-radius: 5px 5px 0 0;
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .notification-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    .notification-item:hover {
      background-color: #f8f9fa;
    }
    .notification-item.unread {
      background-color: #f0f7ff;
    }
    .notification-time {
      font-size: 0.75rem;
      color: #6c757d;
    }
    .car-feature-badge {
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .dashboard-card {
      transition: transform 0.3s;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    .status-badge {
      font-size: 0.8rem;
      padding: 5px 8px;
      border-radius: 4px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .action-buttons .btn {
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    .search-box i {
      position: absolute;
      left: 10px;
      top: 10px;
      color: #6c757d;
    }
    .search-box input {
      padding-left: 35px;
    }
    .pagination {
      justify-content: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar p-0">
        <div class="position-sticky pt-3 h-100">
          <div class="text-center mb-4 p-3 bg-white shadow-sm">
            <h4 class="mb-0">GoPandaCars</h4>
            <p class="text-muted small mb-0">Admin Dashboard</p>
          </div>
          <ul class="nav flex-column px-3">
            <li class="nav-item mb-2">
              <a class="nav-link active" href="#" data-target="dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="bookings">
                <i class="fas fa-calendar-check me-2"></i>Bookings
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="users">
                <i class="fas fa-users me-2"></i>Users
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="offers">
                <i class="fas fa-tag me-2"></i>Offers
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="cars">
                <i class="fas fa-car me-2"></i>Cars
              </a>
            </li>
            <li class="nav-item mt-4 mb-2">
              <a class="nav-link text-danger" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <div class="d-flex align-items-center">
            <h1 class="h2 me-3">Admin Dashboard</h1>
            <div class="position-relative">
              <button class="btn btn-outline-secondary position-relative" id="notificationsBtn">
                <i class="fas fa-bell"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                  0
                </span>
              </button>
              <div class="dropdown-menu dropdown-menu-end p-0 shadow" id="notificationsDropdown" style="width: 350px; max-height: 400px; overflow-y: auto; display: none;">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                  <h6 class="mb-0 fw-bold">Notifications</h6>
                  <button class="btn btn-sm btn-outline-secondary" id="clearNotificationsBtn">Clear All</button>
                </div>
                <div id="notificationsList">
                  <div class="p-3 text-center text-muted">No new notifications</div>
                </div>
              </div>
            </div>
          </div>
          <div class="text-muted">
            <i class="fas fa-calendar-alt me-1"></i>
            <span id="currentDate"></span>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection">
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-white bg-primary mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Total Bookings</h5>
                      <h2 class="card-text" id="totalBookings">0</h2>
                    </div>
                    <i class="fas fa-calendar fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">This month: <span id="monthlyBookings">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Confirmed</h5>
                      <h2 class="card-text" id="confirmedBookings">0</h2>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">This month: <span id="monthlyConfirmed">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Pending</h5>
                      <h2 class="card-text" id="pendingBookings">0</h2>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">Needs action: <span id="pendingAction">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-danger mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Cancelled</h5>
                      <h2 class="card-text" id="cancelledBookings">0</h2>
                    </div>
                    <i class="fas fa-times-circle fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">This month: <span id="monthlyCancelled">0</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-8">
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Bookings Overview</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="bookingsChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Revenue</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                  </div>
                  <div class="text-center mt-3">
                    <h4>â‚¹<span id="totalRevenue">0</span></h4>
                    <p class="text-muted small mb-0">Total revenue this month</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Recent Bookings</h5>
                  <a href="#" class="btn btn-sm btn-outline-primary" id="viewAllBookings">View All</a>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Booking ID</th>
                          <th>Car</th>
                          <th>Customer</th>
                          <th>Dates</th>
                          <th>Status</th>
                          <th>Amount</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="recentBookingsTable">
                        <tr>
                          <td colspan="7" class="text-center loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookingsSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Bookings</h4>
            <div class="d-flex">
              <div class="search-box me-3">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="bookingSearch" placeholder="Search bookings...">
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Filter
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item filter-booking active" data-status="all" href="#">All Bookings</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item filter-booking" data-status="pending_payment" href="#">Pending Payment</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="awaiting_verification" href="#">Awaiting Verification</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="confirmed" href="#">Confirmed</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="active" href="#">Active</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="completed" href="#">Completed</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="cancelled" href="#">Cancelled</a></li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Booking ID</th>
                      <th>Car</th>
                      <th>Customer</th>
                      <th>Dates</th>
                      <th>Status</th>
                      <th>Amount</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="bookingsList">
                    <tr>
                      <td colspan="7" class="text-center loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <nav aria-label="Bookings pagination" class="p-3">
                <ul class="pagination mb-0" id="bookingsPagination">
                  <!-- Pagination will be added here dynamically -->
                </ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Users</h4>
            <div class="d-flex">
              <div class="search-box me-3">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Filter
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item filter-user active" data-status="all" href="#">All Users</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item filter-user" data-status="active" href="#">Active</a></li>
                  <li><a class="dropdown-item filter-user" data-status="blocked" href="#">Blocked</a></li>
                  <li><a class="dropdown-item filter-user" data-status="with_bookings" href="#">With Bookings</a></li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>User</th>
                      <th>Email</th>
                      <th>Joined</th>
                      <th>Bookings</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="usersList">
                    <tr>
                      <td colspan="6" class="text-center loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <nav aria-label="Users pagination" class="p-3">
                <ul class="pagination mb-0" id="usersPagination">
                  <!-- Pagination will be added here dynamically -->
                </ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- Offers Section -->
        <div id="offersSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Offers</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOfferModal">
              <i class="fas fa-plus me-1"></i> Add New Offer
            </button>
          </div>
          
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Code</th>
                      <th>Name</th>
                      <th>Discount</th>
                      <th>Valid Until</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="offersList">
                    <tr>
                      <td colspan="6" class="text-center loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Cars Section -->
        <div id="carsSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Cars</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCarModal">
              <i class="fas fa-plus me-1"></i> Add New Car
            </button>
          </div>
          
          <div class="row" id="carsGrid">
            <div class="col-12 text-center loading-spinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Offer Modal -->
  <div class="modal fade" id="addOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="offerForm">
            <div class="mb-3">
              <label class="form-label">Offer Code*</label>
              <input type="text" class="form-control" id="offerCode" required>
              <small class="text-muted">Unique code customers will enter (e.g., SUMMER20)</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Offer Name*</label>
              <input type="text" class="form-control" id="offerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="offerDescription" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Type*</label>
                <select class="form-select" id="discountType" required>
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Value*</label>
                <input type="number" class="form-control" id="discountValue" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Valid Until*</label>
              <input type="date" class="form-control" id="validUntil" required>
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="isActive" checked>
              <label class="form-check-label" for="isActive">Active</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveOfferBtn" class="btn btn-primary">
            <span class="submit-text">Save Offer</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Car Modal -->
  <div class="modal fade" id="addCarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Car</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="carForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Car Name*</label>
                <input type="text" class="form-control" id="carName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category*</label>
                <select class="form-select" id="carCategory" required>
                  <option value="economy">Economy</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Image URL*</label>
              <input type="url" class="form-control" id="carImage" required>
              <small class="text-muted">Paste a direct image URL (e.g., from Imgur)</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Description*</label>
              <textarea class="form-control" id="carDescription" rows="3" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">12 Hours Price (â‚¹)*</label>
                <input type="number" class="form-control" id="carPrice12hrs" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">24 Hours Price (â‚¹)*</label>
                <input type="number" class="form-control" id="carPrice24hrs" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Features</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="carSunroof">
                  <label class="form-check-label" for="carSunroof">Sunroof</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="carWithDriver">
                  <label class="form-check-label" for="carWithDriver">With Driver</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Transmission</label>
                <select class="form-select" id="carTransmission">
                  <option value="automatic">Automatic</option>
                  <option value="manual">Manual</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveCarBtn" class="btn btn-primary">
            <span class="submit-text">Save Car</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bookingModalBody">
          Loading booking details...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="cancelBookingBtn" style="display:none;">Cancel Booking</button>
          <button type="button" class="btn btn-success" id="confirmBookingBtn" style="display:none;">Confirm Booking</button>
          <button type="button" class="btn btn-primary" id="verifyPaymentBtn" style="display:none;">Verify Payment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="userModalBody">
          Loading user details...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="blockUserBtn" style="display:none;">Block User</button>
          <button type="button" class="btn btn-success" id="unblockUserBtn" style="display:none;">Unblock User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Verify Payment Modal -->
  <div class="modal fade" id="verifyPaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Verify Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="verifyPaymentForm">
            <div class="mb-3">
              <label class="form-label">Payment Verified?</label>
              <select class="form-select" id="verificationStatus" required>
                <option value="verified">Yes, Payment Verified</option>
                <option value="rejected">No, Reject Payment</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Admin Notes</label>
              <textarea class="form-control" id="verificationNotes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="submitVerificationBtn" class="btn btn-primary">
            <span class="submit-text">Submit Verification</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  
  <script>
    // Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
  authDomain: "gopandacars-7085f.firebaseapp.com",
  projectId: "gopandacars-7085f",
  storageBucket: "gopandacars-7085f.appspot.com",
  messagingSenderId: "486383420605",
  appId: "1:486383420605:web:9a8b5e0c8c7f5a8f0a8b1e"
};

// Initialize Firebase
if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();
const messaging = firebase.messaging();

// DOM elements
const logoutBtn = document.getElementById('logoutBtn');
const dashboardSection = document.getElementById('dashboardSection');
const bookingsSection = document.getElementById('bookingsSection');
const usersSection = document.getElementById('usersSection');
const offersSection = document.getElementById('offersSection');
const carsSection = document.getElementById('carsSection');
const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
const userModal = new bootstrap.Modal(document.getElementById('userModal'));
const addOfferModal = new bootstrap.Modal(document.getElementById('addOfferModal'));
const addCarModal = new bootstrap.Modal(document.getElementById('addCarModal'));
const verifyPaymentModal = new bootstrap.Modal(document.getElementById('verifyPaymentModal'));
const notificationBadge = document.getElementById('notificationBadge');
const notificationsList = document.getElementById('notificationsList');
const notificationsDropdown = document.getElementById('notificationsDropdown');
const notificationsBtn = document.getElementById('notificationsBtn');
const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
const viewAllBookings = document.getElementById('viewAllBookings');
const currentDateElement = document.getElementById('currentDate');

// Global variables
let currentBookingId = null;
let currentUserId = null;
let lastBookingTimestamp = null;
let unreadNotifications = 0;
let bookingsChart = null;
let revenueChart = null;
let fcmToken = null;
let isServiceWorkerRegistered = false;

// Current date display
const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
currentDateElement.textContent = new Date().toLocaleDateString('en-US', options);

// Check auth state
auth.onAuthStateChanged(async user => {
  if (user) {
    // Check if user is admin
    if (user.email === 'admin@gopandacars.in') {
      // Admin user
      loadDashboard();
      setupEventListeners();
      
      try {
        // Register service worker first
        await registerServiceWorker();
        
        // Then setup notifications
        await setupNotifications();
        
        // Request notification permission and get FCM token
        await requestNotificationPermission();
        fcmToken = await getFCMToken();
        if (fcmToken) {
          await saveTokenToDatabase(fcmToken, user.uid);
        }
      } catch (error) {
        console.error("Error setting up notifications:", error);
      }
    } else {
      // Not admin
      window.location.href = 'profile.html';
    }
  } else {
    // No user signed in
    window.location.href = 'login.html';
  }
});

// Register service worker
function registerServiceWorker() {
  return new Promise((resolve, reject) => {
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(registration => {
          console.log('Service Worker registered');
          isServiceWorkerRegistered = true;
          resolve();
        })
        .catch(err => {
          console.log('Service Worker registration failed: ', err);
          reject(err);
        });
    } else {
      reject(new Error('Service workers not supported'));
    }
  });
}

// Request notification permission
function requestNotificationPermission() {
  return new Promise((resolve, reject) => {
    if (!('Notification' in window)) {
      reject(new Error('Notifications not supported'));
      return;
    }

    Notification.requestPermission().then(permission => {
      if (permission === 'granted') {
        console.log('Notification permission granted.');
        resolve();
      } else {
        console.log('Unable to get permission to notify.');
        reject(new Error('Permission not granted'));
      }
    });
  });
}

// Get FCM token
function getFCMToken() {
  return messaging.getToken({ 
    vapidKey: 'BEl62iUYgUivxIkv69yViEuiBIa-Ib9-LtkBO3TGPCZJQGeEaEf7kzo6kF7mXmr8TZHX-z3lpY7pZ0KNhqM4e4E',
    serviceWorkerRegistration: navigator.serviceWorker.getRegistration()
  }).then(currentToken => {
    if (currentToken) {
      console.log('FCM Token:', currentToken);
      return currentToken;
    } else {
      console.log('No registration token available. Request permission to generate one.');
      return null;
    }
  }).catch(err => {
    console.log('An error occurred while retrieving token. ', err);
    throw err;
  });
}

// Save token to database
function saveTokenToDatabase(token, userId) {
  return db.collection('admin_tokens').doc(userId).set({
    token: token,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: true });
}

// Setup foreground message handler
function setupForegroundMessageHandler() {
  messaging.onMessage(payload => {
    console.log('Foreground message received:', payload);
    
    // Update notification badge
    unreadNotifications++;
    updateNotificationBadge();
    
    // Show notification
    showNotification(payload.notification.title, payload.notification.body, payload.data);
    
    // Add to notifications list
    addNotificationToList(payload.notification.title, payload.notification.body, payload.data);
  });
}

// Show browser notification
function showNotification(title, body, data) {
  const notificationOptions = {
    body: body,
    icon: '/images/logo.png',
    badge: '/images/badge.png',
    vibrate: [200, 100, 200],
    data: data
  };

  if ('serviceWorker' in navigator && isServiceWorkerRegistered) {
    navigator.serviceWorker.ready.then(registration => {
      registration.showNotification(title, notificationOptions);
    });
  } else if ('Notification' in window && Notification.permission === 'granted') {
    new Notification(title, notificationOptions);
  }
}

// Add notification to the dropdown list
function addNotificationToList(title, body, data) {
  const notificationItem = document.createElement('div');
  notificationItem.className = 'notification-item unread';
  
  const now = new Date();
  const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
  
  notificationItem.innerHTML = `
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <strong>${title}</strong>
        <p class="mb-1">${body}</p>
        <p class="mb-0 notification-time">${timeString}</p>
      </div>
      ${data.bookingId ? `
        <a href="#" class="btn btn-sm btn-outline-primary view-notification" data-booking-id="${data.bookingId}">View</a>
      ` : ''}
    </div>
  `;
  
  // Add to top of list
  if (notificationsList.firstChild) {
    notificationsList.insertBefore(notificationItem, notificationsList.firstChild);
  } else {
    notificationsList.appendChild(notificationItem);
  }
  
  // Add click handler for view button if it exists
  const viewBtn = notificationItem.querySelector('.view-notification');
  if (viewBtn) {
    viewBtn.addEventListener('click', e => {
      e.preventDefault();
      if (data.bookingId) {
        viewBookingDetails(data.bookingId);
      }
      notificationsDropdown.style.display = 'none';
    });
  }
}

// Setup notifications system
async function setupNotifications() {
  // Load last booking timestamp from localStorage
  const lastTimestamp = localStorage.getItem('lastBookingTimestamp');
  if (lastTimestamp) {
    lastBookingTimestamp = new Date(parseInt(lastTimestamp));
  }
  
  // Load existing notifications from database
  await loadNotificationsFromDatabase();
  
  // Set up real-time listener for new bookings
  setupBookingNotifications();
  
  // Setup foreground message handler
  setupForegroundMessageHandler();
  
  // Setup notification UI handlers
  setupNotificationUIHandlers();
}

// Load notifications from database
async function loadNotificationsFromDatabase() {
  try {
    const userId = auth.currentUser?.uid;
    if (!userId) return;

    const snapshot = await db.collection('notifications')
      .where('userId', '==', userId)
      .orderBy('createdAt', 'desc')
      .limit(20)
      .get();

    notificationsList.innerHTML = '';

    if (snapshot.empty) {
      notificationsList.innerHTML = '<div class="p-3 text-center text-muted">No notifications</div>';
      return;
    }

    snapshot.forEach(doc => {
      const notification = doc.data();
      addNotificationToList(
        notification.title,
        notification.body,
        notification.data
      );
    });

    // Update unread count
    const unreadSnapshot = await db.collection('notifications')
      .where('userId', '==', userId)
      .where('read', '==', false)
      .count()
      .get();

    unreadNotifications = unreadSnapshot.data().count;
    updateNotificationBadge();
  } catch (error) {
    console.error("Error loading notifications:", error);
    notificationsList.innerHTML = '<div class="p-3 text-center text-muted">Error loading notifications</div>';
  }
}

// Setup booking notifications
function setupBookingNotifications() {
  db.collection('bookings').orderBy('createdAt', 'desc').limit(1)
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        if (change.type === 'added') {
          const booking = change.doc.data();
          const bookingTime = booking.createdAt.toDate();
          
          // Check if this is a new booking since last check
          if (!lastBookingTimestamp || bookingTime > lastBookingTimestamp) {
            lastBookingTimestamp = bookingTime;
            localStorage.setItem('lastBookingTimestamp', bookingTime.getTime().toString());
            
            // Only show notification if not initial load
            if (lastBookingTimestamp) {
              handleNewBooking(change.doc.id, booking);
            }
          }
        }
      });
    });
}

// Handle new booking notification
async function handleNewBooking(bookingId, booking) {
  // Add to in-app notifications
  addNewBookingNotification(bookingId, booking);
  
  // Create notification data
  const notificationData = {
    title: 'New Booking Received',
    body: `${booking.carName || 'A car'} booked by ${booking.userEmail || 'a customer'}`,
    data: { bookingId },
    userId: auth.currentUser.uid,
    read: false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  
  try {
    // Save to database
    await db.collection('notifications').add(notificationData);
    
    // Send push notification
    await sendPushNotification(
      notificationData.title,
      notificationData.body,
      notificationData.data
    );
  } catch (error) {
    console.error("Error handling new booking notification:", error);
  }
}

// Setup notification UI handlers
function setupNotificationUIHandlers() {
  // Notification button click handler
  notificationsBtn.addEventListener('click', () => {
    notificationsDropdown.style.display = notificationsDropdown.style.display === 'block' ? 'none' : 'block';
    markNotificationsAsRead();
  });
  
  // Clear notifications button
  clearNotificationsBtn.addEventListener('click', clearNotifications);
  
  // Close dropdown when clicking outside
  document.addEventListener('click', e => {
    if (!notificationsBtn.contains(e.target) && !notificationsDropdown.contains(e.target)) {
      notificationsDropdown.style.display = 'none';
    }
  });
}

// Send push notification
async function sendPushNotification(title, body, data = {}) {
  try {
    // In a real app, you would send this from your server
    // This is just for demonstration
    if ('serviceWorker' in navigator && isServiceWorkerRegistered) {
      const registration = await navigator.serviceWorker.ready;
      registration.showNotification(title, {
        body: body,
        icon: '/images/logo.png',
        badge: '/images/badge.png',
        data: data
      });
    } else if ('Notification' in window && Notification.permission === 'granted') {
      new Notification(title, {
        body: body,
        data: data
      });
    }
  } catch (error) {
    console.error("Error sending push notification:", error);
  }
}

function addNewBookingNotification(bookingId, booking) {
  unreadNotifications++;
  updateNotificationBadge();
  
  const notificationItem = document.createElement('div');
  notificationItem.className = 'notification-item unread';
  notificationItem.innerHTML = `
    <div class="d-flex justify-content-between align-items-start">
      <div>
        <strong>New Booking</strong>
        <p class="mb-1">${booking.carName || 'Unknown car'} booked by ${booking.userEmail || 'unknown user'}</p>
        <p class="mb-0 notification-time">${new Date().toLocaleTimeString()}</p>
      </div>
      <a href="#" class="btn btn-sm btn-outline-primary view-notification" data-booking-id="${bookingId}">View</a>
    </div>
  `;
  
  // Add to top of list
  if (notificationsList.firstChild) {
    notificationsList.insertBefore(notificationItem, notificationsList.firstChild);
  } else {
    notificationsList.appendChild(notificationItem);
  }
  
  // Add click handler for view button
  notificationItem.querySelector('.view-notification').addEventListener('click', e => {
    e.preventDefault();
    viewBookingDetails(bookingId);
    notificationsDropdown.style.display = 'none';
  });
}

function updateNotificationBadge() {
  if (unreadNotifications > 0) {
    notificationBadge.style.display = 'block';
    notificationBadge.textContent = unreadNotifications;
  } else {
    notificationBadge.style.display = 'none';
  }
}

async function markNotificationsAsRead() {
  try {
    const userId = auth.currentUser?.uid;
    if (!userId) return;

    // Update in database
    const batch = db.batch();
    const snapshot = await db.collection('notifications')
      .where('userId', '==', userId)
      .where('read', '==', false)
      .get();

    snapshot.forEach(doc => {
      batch.update(doc.ref, {
        read: true,
        readAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    });

    await batch.commit();

    // Update UI
    unreadNotifications = 0;
    updateNotificationBadge();
    document.querySelectorAll('.notification-item.unread').forEach(item => {
      item.classList.remove('unread');
    });
  } catch (error) {
    console.error("Error marking notifications as read:", error);
  }
}

async function clearNotifications() {
  try {
    const userId = auth.currentUser?.uid;
    if (!userId) return;

    // Delete from database
    const batch = db.batch();
    const snapshot = await db.collection('notifications')
      .where('userId', '==', userId)
      .get();

    snapshot.forEach(doc => {
      batch.delete(doc.ref);
    });

    await batch.commit();

    // Update UI
    notificationsList.innerHTML = '<div class="p-3 text-center text-muted">No notifications</div>';
    unreadNotifications = 0;
    updateNotificationBadge();
  } catch (error) {
    console.error("Error clearing notifications:", error);
  }
}

// [Rest of your existing functions...]

// Initialize the app
function initializeApp() {
  // Check if service worker is supported
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      registerServiceWorker().catch(err => {
        console.log('ServiceWorker registration failed: ', err);
      });
    });
  }

  // Check auth state
  auth.onAuthStateChanged(user => {
    if (user) {
      if (user.email === 'admin@gopandacars.in') {
        loadDashboard();
        setupEventListeners();
        setupNotifications().catch(err => {
          console.error('Notification setup failed:', err);
        });
      } else {
        window.location.href = 'profile.html';
      }
    } else {
      window.location.href = 'login.html';
    }
  });
}

// Start the app
initializeApp();
  </script>
</body>
</html>
