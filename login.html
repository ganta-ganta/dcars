<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login | GoPandaCars</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .login-container {
      max-width: 500px;
      margin: 0 auto;
      margin-top: 100px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
      border-radius: 10px;
      overflow: hidden;
    }
    .login-header {
      background: linear-gradient(135deg, #6e8efb, #a777e3);
      color: white;
      padding: 20px;
      text-align: center;
    }
    .login-body {
      padding: 30px;
      background: white;
    }
    .tab-content {
      padding-top: 20px;
    }
    .btn-verify {
      display: none;
    }
    .countdown {
      color: #6c757d;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-container">
      <div class="login-header">
        <h3><i class="fas fa-car me-2"></i> GoPandaCars</h3>
        <p class="mb-0">Login to your account</p>
      </div>
      
      <div class="login-body">
        <ul class="nav nav-tabs" id="loginTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="phone-tab" data-bs-toggle="tab" data-bs-target="#phone-login" type="button">Phone Login</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="email-tab" data-bs-toggle="tab" data-bs-target="#email-login" type="button">Email Login</button>
          </li>
        </ul>
        
        <div class="tab-content" id="loginTabsContent">
          <!-- Phone Login Tab -->
          <div class="tab-pane fade show active" id="phone-login" role="tabpanel">
            <div id="phone-login-form">
              <div class="mb-3">
                <label for="phoneNumber" class="form-label">Phone Number</label>
                <div class="input-group">
                  <span class="input-group-text">+91</span>
                  <input type="tel" class="form-control" id="phoneNumber" placeholder="Enter 10-digit mobile number" maxlength="10">
                </div>
              </div>
              <button id="sendOtpBtn" class="btn btn-primary w-100">Send OTP</button>
            </div>
            
            <div id="otp-verification-form" style="display: none;">
              <div class="mb-3">
                <label for="otpCode" class="form-label">Enter 6-digit OTP</label>
                <input type="text" class="form-control" id="otpCode" placeholder="XXXXXX" maxlength="6">
                <div class="countdown mt-1" id="otpCountdown">OTP valid for: 02:00</div>
              </div>
              <button id="verifyOtpBtn" class="btn btn-success w-100 mb-2">Verify OTP</button>
              <button id="resendOtpBtn" class="btn btn-outline-secondary w-100">Resend OTP</button>
            </div>
            
            <div id="phone-login-error" class="alert alert-danger mt-3" style="display: none;"></div>
          </div>
          
          <!-- Email Login Tab -->
          <div class="tab-pane fade" id="email-login" role="tabpanel">
            <form id="emailLoginForm">
              <div class="mb-3">
                <label for="email" class="form-label">Email address</label>
                <input type="email" class="form-control" id="email" required>
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">Login</button>
            </form>
            <div class="text-center mt-3">
              <a href="forgot-password.html">Forgot password?</a>
            </div>
          </div>
        </div>
        
        <div class="text-center mt-4">
          <p>Don't have an account? <a href="register.html">Register here</a></p>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
      authDomain: "gopandacars-7085f.firebaseapp.com",
      projectId: "gopandacars-7085f",
      storageBucket: "gopandacars-7085f.appspot.com",
      messagingSenderId: "486383420605"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    
    // Phone OTP variables
    let verificationId = null;
    let countdownInterval = null;
    let timeLeft = 120; // 2 minutes in seconds
    
    // DOM elements
    const phoneLoginForm = document.getElementById('phone-login-form');
    const otpVerificationForm = document.getElementById('otp-verification-form');
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    const verifyOtpBtn = document.getElementById('verifyOtpBtn');
    const resendOtpBtn = document.getElementById('resendOtpBtn');
    const phoneNumberInput = document.getElementById('phoneNumber');
    const otpCodeInput = document.getElementById('otpCode');
    const otpCountdown = document.getElementById('otpCountdown');
    const phoneLoginError = document.getElementById('phone-login-error');
    const emailLoginForm = document.getElementById('emailLoginForm');
    
    // Send OTP button click handler
    sendOtpBtn.addEventListener('click', () => {
      const phoneNumber = '+91' + phoneNumberInput.value.trim();
      
      if (!phoneNumberInput.value || phoneNumberInput.value.length !== 10) {
        showPhoneError('Please enter a valid 10-digit phone number');
        return;
      }
      
      sendOtpBtn.disabled = true;
      sendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending OTP...';
      
      // Firebase phone auth
      const appVerifier = new firebase.auth.RecaptchaVerifier('sendOtpBtn', {
        size: 'invisible',
        callback: () => {
          // reCAPTCHA solved, will proceed with sending OTP
        }
      });
      
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then(confirmationResult => {
          verificationId = confirmationResult.verificationId;
          phoneLoginForm.style.display = 'none';
          otpVerificationForm.style.display = 'block';
          startCountdown();
          sendOtpBtn.disabled = false;
          sendOtpBtn.innerHTML = 'Send OTP';
        })
        .catch(error => {
          console.error('Error sending OTP:', error);
          showPhoneError(getErrorMessage(error.code));
          sendOtpBtn.disabled = false;
          sendOtpBtn.innerHTML = 'Send OTP';
        });
    });
    
    // Verify OTP button click handler
    verifyOtpBtn.addEventListener('click', () => {
      const otpCode = otpCodeInput.value.trim();
      
      if (!otpCode || otpCode.length !== 6) {
        showPhoneError('Please enter a valid 6-digit OTP');
        return;
      }
      
      verifyOtpBtn.disabled = true;
      verifyOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Verifying...';
      
      const credential = firebase.auth.PhoneAuthProvider.credential(verificationId, otpCode);
      
      auth.signInWithCredential(credential)
        .then(userCredential => {
          // User signed in successfully
          window.location.href = 'profile.html';
        })
        .catch(error => {
          console.error('Error verifying OTP:', error);
          showPhoneError(getErrorMessage(error.code));
          verifyOtpBtn.disabled = false;
          verifyOtpBtn.innerHTML = 'Verify OTP';
        });
    });
    
    // Resend OTP button click handler
    resendOtpBtn.addEventListener('click', () => {
      const phoneNumber = '+91' + phoneNumberInput.value.trim();
      
      resendOtpBtn.disabled = true;
      resendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
      
      const appVerifier = new firebase.auth.RecaptchaVerifier('resendOtpBtn', {
        size: 'invisible'
      });
      
      auth.signInWithPhoneNumber(phoneNumber, appVerifier)
        .then(confirmationResult => {
          verificationId = confirmationResult.verificationId;
          resetCountdown();
          resendOtpBtn.disabled = false;
          resendOtpBtn.innerHTML = 'Resend OTP';
          showPhoneError('New OTP sent successfully!', 'success');
        })
        .catch(error => {
          console.error('Error resending OTP:', error);
          showPhoneError(getErrorMessage(error.code));
          resendOtpBtn.disabled = false;
          resendOtpBtn.innerHTML = 'Resend OTP';
        });
    });
    
    // Email login form submission
    emailLoginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      
      auth.signInWithEmailAndPassword(email, password)
        .then(() => {
          window.location.href = 'profile.html';
        })
        .catch(error => {
          alert(getErrorMessage(error.code));
        });
    });
    
    // Helper functions
    function startCountdown() {
      clearInterval(countdownInterval);
      timeLeft = 120;
      updateCountdownDisplay();
      
      countdownInterval = setInterval(() => {
        timeLeft--;
        updateCountdownDisplay();
        
        if (timeLeft <= 0) {
          clearInterval(countdownInterval);
          otpCountdown.textContent = 'OTP expired';
          otpCountdown.style.color = 'red';
        }
      }, 1000);
    }
    
    function resetCountdown() {
      clearInterval(countdownInterval);
      timeLeft = 120;
      updateCountdownDisplay();
      otpCountdown.style.color = '#6c757d';
      startCountdown();
    }
    
    function updateCountdownDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      otpCountdown.textContent = `OTP valid for: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function showPhoneError(message, type = 'error') {
      phoneLoginError.textContent = message;
      phoneLoginError.style.display = 'block';
      phoneLoginError.className = `alert alert-${type}`;
      
      setTimeout(() => {
        phoneLoginError.style.display = 'none';
      }, 5000);
    }
    
    function getErrorMessage(errorCode) {
      const errorMessages = {
        'auth/invalid-phone-number': 'Invalid phone number format',
        'auth/missing-phone-number': 'Please enter a phone number',
        'auth/quota-exceeded': 'OTP quota exceeded. Please try again later',
        'auth/code-expired': 'OTP expired. Please request a new one',
        'auth/invalid-verification-code': 'Invalid OTP code',
        'auth/too-many-requests': 'Too many attempts. Please try again later',
        'auth/user-disabled': 'This account has been disabled',
        'auth/user-not-found': 'No account found with this phone number',
        'auth/wrong-password': 'Incorrect email or password',
        'auth/invalid-email': 'Invalid email address'
      };
      
      return errorMessages[errorCode] || 'An error occurred. Please try again';
    }
  </script>
</body>
</html>
