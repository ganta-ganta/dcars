<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Previous head content remains the same -->
</head>
<body>
  <!-- Previous HTML content remains the same until the script section -->

  <script>
    // Firebase configuration and initialization
    const firebaseConfig = {
      apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
      authDomain: "gopandacars-7085f.firebaseapp.com",
      projectId: "gopandacars-7085f",
      storageBucket: "gopandacars-7085f.appspot.com",
      messagingSenderId: "486383420605"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // DOM elements
    const logoutBtn = document.getElementById('logoutBtn');
    const profileForm = document.getElementById('profileForm');
    const bookingsContainer = document.getElementById('bookingsContainer');
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
    const profilePicInput = document.getElementById('profilePicInput');
    const profilePic = document.getElementById('profilePic');
    const updateProfileBtn = document.getElementById('updateProfileBtn');

    // Wait for DOM to load
    document.addEventListener('DOMContentLoaded', () => {
      // Check authentication state
      auth.onAuthStateChanged(user => {
        if (user) {
          // User is signed in, load profile data
          loadUserProfile(user.uid);
          loadUserBookings(user.uid); // This will now work
        } else {
          // No user is signed in, redirect to login
          window.location.href = 'login.html';
        }
      });

      // Setup event listeners
      setupEventListeners();
    });

    // Load user profile data
    async function loadUserProfile(userId) {
      try {
        const doc = await db.collection('users').doc(userId).get();
        if (doc.exists) {
          const userData = doc.data();
          
          // Display all user information
          document.getElementById('userName').textContent = userData.name || 'User';
          document.getElementById('userEmail').textContent = userData.email || 'No email';
          
          // Format phone number display (remove country code)
          const phoneDisplay = userData.phone ? 
                userData.phone.replace('+91', '') : 'Not provided';
          document.getElementById('userPhone').textContent = phoneDisplay;
          
          document.getElementById('userLicense').textContent = 
                userData.driverLicense || 'Not provided';
          document.getElementById('joinDate').textContent = 
                userData.createdAt?.toDate().toLocaleDateString() || 'N/A';
          
          // Set profile picture
          profilePic.src = userData.profilePic || 
                `https://ui-avatars.com/api/?name=${encodeURIComponent(userData.name || 'User')}&background=random`;
          
          // Populate edit form with actual values
          document.getElementById('name').value = userData.name || '';
          document.getElementById('phone').value = phoneDisplay;
          document.getElementById('address').value = userData.address || '';
          document.getElementById('license').value = userData.driverLicense || '';
        }
      } catch (error) {
        console.error("Error loading profile:", error);
        showError("Failed to load profile data. Please try again later.");
      }
    }

    // Load user bookings
    async function loadUserBookings(userId) {
      try {
        // Show loading state
        bookingsContainer.innerHTML = `
          <div class="col-12 text-center py-5 loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading your bookings...</p>
          </div>
        `;

        // First try the indexed query
        let querySnapshot;
        try {
          querySnapshot = await db.collection('bookings')
            .where('userId', '==', userId)
            .orderBy('createdAt', 'desc')
            .get();
        } catch (error) {
          if (error.code === 'failed-precondition') {
            // Fallback to client-side sorting
            const allBookings = await db.collection('bookings')
              .where('userId', '==', userId)
              .get();
            
            querySnapshot = {
              docs: allBookings.docs.sort((a, b) => {
                const aDate = a.data().createdAt?.toMillis?.() || 0;
                const bDate = b.data().createdAt?.toMillis?.() || 0;
                return bDate - aDate;
              })
            };
          } else {
            throw error;
          }
        }

        // Check if there are any bookings
        if (!querySnapshot.docs || querySnapshot.docs.length === 0) {
          bookingsContainer.innerHTML = `
            <div class="col-12">
              <div class="alert alert-info">
                You don't have any bookings yet. <a href="index.html" class="alert-link">Book a car now!</a>
              </div>
            </div>
          `;
          return;
        }

        // Process and display bookings
        let bookingsHTML = '';
        querySnapshot.docs.forEach(doc => {
          const booking = doc.data();
          // Clean up data
          const cleanedBooking = {
            ...booking,
            carId: booking.carId?.trim() || '',
            status: booking.status?.trim() || 'pending',
            startDate: booking.startDate?.trim() || '',
            endDate: booking.endDate?.trim() || ''
          };
          bookingsHTML += createBookingCard(cleanedBooking, doc.id);
        });

        bookingsContainer.innerHTML = bookingsHTML;
        setupBookingEventListeners();

      } catch (error) {
        console.error("Error loading bookings:", error);
        
        bookingsContainer.innerHTML = `
          <div class="col-12">
            <div class="alert alert-danger">
              Failed to load bookings: ${error.message}
              ${error.code === 'failed-precondition' ? 
                '<p class="mt-2">The database is still creating the required index. This may take a few minutes.</p>' : ''}
              <button class="btn btn-sm btn-primary mt-2" onclick="window.location.reload()">
                <i class="fas fa-sync-alt me-1"></i> Try Again
              </button>
            </div>
          </div>
        `;
      }
    }

    // Create booking card HTML
    function createBookingCard(booking, bookingId) {
      const statusClass = getStatusClass(booking.status);
      const startDate = formatDate(booking.startDate);
      const endDate = formatDate(booking.endDate);
      const createdAt = formatDateTime(booking.createdAt);
      
      return `
        <div class="col-md-6 mb-4">
          <div class="card booking-card h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">${booking.carName || 'N/A'}</h5>
              <span class="badge ${statusClass}">${booking.status}</span>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-6">
                  <p><strong>Booking ID:</strong></p>
                  <p><strong>Dates:</strong></p>
                  <p><strong>Price:</strong></p>
                  <p><strong>Booked On:</strong></p>
                </div>
                <div class="col-6">
                  <p>${bookingId.substring(0, 8)}</p>
                  <p>${startDate} - ${endDate}</p>
                  <p>â‚¹${booking.finalPrice || booking.originalPrice || '0'}</p>
                  <p>${createdAt}</p>
                </div>
              </div>
            </div>
            <div class="card-footer bg-white">
              <button class="btn btn-sm btn-outline-primary view-booking" data-booking-id="${bookingId}">
                <i class="fas fa-eye me-1"></i> View Details
              </button>
              ${booking.status === 'pending_payment' ? `
                <button class="btn btn-sm btn-success pay-now ms-2" data-booking-id="${bookingId}">
                  <i class="fas fa-credit-card me-1"></i> Pay Now
                </button>
              ` : ''}
              ${booking.status === 'confirmed' ? `
                <button class="btn btn-sm btn-outline-danger cancel-booking ms-2" data-booking-id="${bookingId}">
                  <i class="fas fa-times me-1"></i> Cancel
                </button>
              ` : ''}
            </div>
          </div>
        </div>
      `;
    }

    // Setup booking event listeners
    function setupBookingEventListeners() {
      // View booking details
      document.querySelectorAll('.view-booking').forEach(button => {
        button.addEventListener('click', (e) => {
          const bookingId = e.currentTarget.getAttribute('data-booking-id');
          viewBookingDetails(bookingId);
        });
      });

      // Pay for booking
      document.querySelectorAll('.pay-now').forEach(button => {
        button.addEventListener('click', (e) => {
          const bookingId = e.currentTarget.getAttribute('data-booking-id');
          window.location.href = `pay.html?bookingId=${bookingId}`;
        });
      });

      // Cancel booking
      document.querySelectorAll('.cancel-booking').forEach(button => {
        button.addEventListener('click', (e) => {
          const bookingId = e.currentTarget.getAttribute('data-booking-id');
          cancelBooking(bookingId);
        });
      });
    }

    // View booking details
    async function viewBookingDetails(bookingId) {
      try {
        document.getElementById('bookingModalBody').innerHTML = `
          <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading booking details...</p>
          </div>
        `;
        
        bookingModal.show();
        
        const doc = await db.collection('bookings').doc(bookingId).get();
        if (!doc.exists) {
          throw new Error('Booking not found');
        }

        const booking = doc.data();
        document.getElementById('bookingModalBody').innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h5>${booking.carName || 'N/A'}</h5>
              <p class="text-muted">${booking.carCategory || 'N/A'}</p>
              <hr>
              <p><strong>Status:</strong> <span class="badge ${getStatusClass(booking.status)}">${booking.status}</span></p>
              <p><strong>Booking ID:</strong> ${bookingId}</p>
              <p><strong>Dates:</strong> ${formatDate(booking.startDate)} - ${formatDate(booking.endDate)}</p>
              <p><strong>Booked On:</strong> ${formatDateTime(booking.createdAt)}</p>
            </div>
            <div class="col-md-6">
              <h5>Payment Details</h5>
              <hr>
              <p><strong>Original Price:</strong> â‚¹${booking.originalPrice || '0'}</p>
              ${booking.discountApplied ? `
                <p><strong>Discount:</strong> ${booking.discountCode || ''} (â‚¹${booking.discountAmount || '0'})</p>
              ` : ''}
              <p><strong>Final Price:</strong> â‚¹${booking.finalPrice || booking.originalPrice || '0'}</p>
              <p><strong>Payment Status:</strong> ${booking.paymentStatus || 'Pending'}</p>
            </div>
          </div>
        `;
      } catch (error) {
        console.error("Error loading booking details:", error);
        document.getElementById('bookingModalBody').innerHTML = `
          <div class="alert alert-danger">
            Error loading booking details: ${error.message}
          </div>
        `;
      }
    }

    // Cancel booking
    async function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;
      
      try {
        await db.collection('bookings').doc(bookingId).update({
          status: 'cancelled',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        loadUserBookings(auth.currentUser.uid);
        showSuccess('Booking cancelled successfully');
      } catch (error) {
        console.error("Error cancelling booking:", error);
        showError('Failed to cancel booking: ' + error.message);
      }
    }

    // Helper function for status styling
    function getStatusClass(status) {
      switch(status) {
        case 'confirmed': return 'bg-success';
        case 'pending_payment': return 'bg-warning text-dark';
        case 'cancelled': return 'bg-secondary';
        case 'completed': return 'bg-primary';
        default: return 'bg-info';
      }
    }

    // Format date for display
    function formatDate(date) {
      if (!date) return 'N/A';
      if (date.toDate) {
        return date.toDate().toLocaleDateString();
      }
      try {
        return new Date(date).toLocaleDateString();
      } catch {
        return date;
      }
    }

    // Format datetime for display
    function formatDateTime(date) {
      if (!date) return 'N/A';
      if (date.toDate) {
        return date.toDate().toLocaleString();
      }
      try {
        return new Date(date).toLocaleString();
      } catch {
        return date;
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Logout button
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      });

      // Profile form submission
      profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = auth.currentUser.uid;
        const originalBtnText = updateProfileBtn.innerHTML;
        
        try {
          updateProfileBtn.disabled = true;
          updateProfileBtn.innerHTML = `
            <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            Updating...
          `;
          
          // Get phone and add country code before saving
          const phoneValue = document.getElementById('phone').value.trim();
          const phoneWithCode = phoneValue ? '+91' + phoneValue : '';
          
          const profileData = {
            name: document.getElementById('name').value.trim(),
            phone: phoneWithCode,
            address: document.getElementById('address').value.trim(),
            driverLicense: document.getElementById('license').value.trim(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          await db.collection('users').doc(userId).update(profileData);
          
          showSuccess('Profile updated successfully!');
          loadUserProfile(userId);
          
        } catch (error) {
          console.error("Error updating profile:", error);
          showError('Failed to update profile: ' + error.message);
        } finally {
          updateProfileBtn.disabled = false;
          updateProfileBtn.innerHTML = originalBtnText;
        }
      });

      // Profile picture upload
      profilePicInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
          const userId = auth.currentUser.uid;
          const storageRef = storage.ref(`profile_pictures/${userId}`);
          const uploadTask = storageRef.put(file);
          
          // Show loading on profile picture
          const originalSrc = profilePic.src;
          profilePic.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7';
          
          // Wait for upload to complete
          const snapshot = await uploadTask;
          const downloadURL = await snapshot.ref.getDownloadURL();
          
          // Update user profile with new picture URL
          await db.collection('users').doc(userId).update({
            profilePic: downloadURL,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          // Update profile picture
          profilePic.src = downloadURL;
          showSuccess('Profile picture updated successfully!');
        } catch (error) {
          console.error("Error uploading profile picture:", error);
          showError('Failed to update profile picture');
        }
      });
    }

    // Helper function to show success messages
    function showSuccess(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-success alert-dismissible fade show';
      alertDiv.role = 'alert';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      const container = document.querySelector('.container.my-5');
      container.prepend(alertDiv);
      
      setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
      }, 5000);
    }

    // Helper function to show error messages
    function showError(message) {
      const alertDiv = document.createElement('div');
      alertDiv.className = 'alert alert-danger alert-dismissible fade show';
      alertDiv.role = 'alert';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      
      const container = document.querySelector('.container.my-5');
      container.prepend(alertDiv);
      
      setTimeout(() => {
        alertDiv.classList.remove('show');
        setTimeout(() => alertDiv.remove(), 150);
      }, 8000);
    }
  </script>
</body>
</html>
