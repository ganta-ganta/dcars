<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoPanda Cars - Rental Service</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .car-card {
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .car-img {
            height: 200px;
            object-fit: cover;
            width: 100%;
        }
        .badge {
            font-size: 0.8rem;
        }
        .date-filter-btn.active {
            background-color: #0d6efd;
            color: white;
        }
        #availabilityHeader {
            font-weight: 600;
        }
        .no-cars-available {
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .loading-spinner {
            display: none;
            width: 3rem;
            height: 3rem;
        }
        .error-message {
            color: #dc3545;
            font-size: 0.9rem;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">GoPanda Cars</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">About</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Contact</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="loginLink" href="login.html">Login</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="bg-primary text-white py-5">
        <div class="container text-center">
            <h1 class="display-4">Premium Car Rental Service</h1>
            <p class="lead">Book your perfect car for any occasion</p>
        </div>
    </header>

    <!-- Date Filters -->
    <section class="py-4 bg-light">
        <div class="container">
            <div class="row mb-4">
                <div class="col-md-8">
                    <h3 id="availabilityHeader">Available Cars</h3>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-primary date-filter-btn active" data-filter="today">Today</button>
                        <button type="button" class="btn btn-outline-primary date-filter-btn" data-filter="tomorrow">Tomorrow</button>
                        <div class="input-group">
                            <input type="date" class="form-control" id="customDateFilter">
                            <button class="btn btn-primary" type="button" id="applyCustomDate">Go</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-12 text-center">
                    <div class="spinner-border text-primary loading-spinner" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div id="errorMessage" class="error-message"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- Cars Section -->
    <section class="py-5">
        <div class="container">
            <!-- Economy Cars -->
            <h4 class="mb-4"><i class="fas fa-car me-2"></i> Economy Cars</h4>
            <div class="row" id="economyCars">
                <div class="col-12 no-cars-available">
                    <div class="alert alert-info w-100 text-center">
                        Loading economy cars...
                    </div>
                </div>
            </div>

            <!-- Premium Cars -->
            <h4 class="mb-4 mt-5"><i class="fas fa-car-side me-2"></i> Premium Cars</h4>
            <div class="row" id="premiumCars">
                <div class="col-12 no-cars-available">
                    <div class="alert alert-info w-100 text-center">
                        Loading premium cars...
                    </div>
                </div>
            </div>

            <!-- Luxury Cars -->
            <h4 class="mb-4 mt-5"><i class="fas fa-gem me-2"></i> Luxury Cars</h4>
            <div class="row" id="luxuryCars">
                <div class="col-12 no-cars-available">
                    <div class="alert alert-info w-100 text-center">
                        Loading luxury cars...
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Booking Modal -->
    <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Book <span id="modalCarName"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="loginRequired" class="alert alert-info">
                        Please <a href="login.html">login</a> to book this car.
                    </div>
                    
                    <div id="bookingForm">
                        <div class="mb-3">
                            <label class="form-label">Rental Option</label>
                            <select class="form-select" id="rentalOption">
                                <option value="12hrs">12 Hours (₹<span id="price12hrs"></span>)</option>
                                <option value="24hrs">24 Hours (₹<span id="price24hrs"></span>)</option>
                            </select>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Date & Time</label>
                                <input type="datetime-local" class="form-control" id="startDateTime">
                                <div id="startDateError" class="error-message"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Date & Time</label>
                                <input type="datetime-local" class="form-control" id="endDateTime">
                                <div id="endDateError" class="error-message"></div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Phone Number</label>
                            <input type="tel" class="form-control" id="phoneNumber" placeholder="10 digit mobile number">
                            <div id="phoneError" class="error-message"></div>
                        </div>
                        
                        <div class="alert alert-secondary">
                            <strong>Estimated Total: ₹<span id="estimatedTotal">0</span></strong>
                            <p class="mb-0 small" id="billingNote"></p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="confirmBookingBtn">Confirm Booking</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p>&copy; 2023 GoPanda Cars. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Firebase configuration
            const firebaseConfig = {
                apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
                authDomain: "gopandacars-7085f.firebaseapp.com",
                projectId: "gopandacars-7085f",
                storageBucket: "gopandacars-7085f.appspot.com",
                messagingSenderId: "486383420605"
            };
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();

            // UI Elements
            const loadingSpinner = document.querySelector('.loading-spinner');
            const errorMessage = document.getElementById('errorMessage');
            const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
            let selectedCar = null;

            // Car data
            const cars = [
                {
                    id: 'car1',
                    name: 'Swift',
                    image: 'https://via.placeholder.com/600x400?text=Swift',
                    priceHourly: 85,
                    price12hrs: 1200,
                    price24hrs: 2000,
                    description: 'Compact hatchback with great fuel efficiency.',
                    category: 'economy'
                },
                {
                    id: 'car2',
                    name: 'Etios',
                    image: 'https://via.placeholder.com/600x400?text=Etios',
                    priceHourly: 85,
                    price12hrs: 1200,
                    price24hrs: 2000,
                    description: 'Reliable sedan with spacious interior.',
                    category: 'economy'
                },
                {
                    id: 'car3',
                    name: 'I10 Nios',
                    image: 'https://via.placeholder.com/600x400?text=I10+Nios',
                    priceHourly: 100,
                    price12hrs: 1500,
                    price24hrs: 2300,
                    description: 'Premium hatchback with modern features.',
                    category: 'economy'
                },
                {
                    id: 'car4',
                    name: 'Swift Dzire',
                    image: 'https://via.placeholder.com/600x400?text=Swift+Dzire',
                    priceHourly: 100,
                    price12hrs: 1500,
                    price24hrs: 2300,
                    description: 'Popular compact sedan.',
                    category: 'economy'
                },
                {
                    id: 'car5',
                    name: 'Hyundai Aura',
                    image: 'https://via.placeholder.com/600x400?text=Hyundai+Aura',
                    priceHourly: 105,
                    price12hrs: 1500,
                    price24hrs: 2500,
                    description: 'Stylish compact sedan.',
                    category: 'premium'
                },
                {
                    id: 'car6',
                    name: 'Tata Punch',
                    image: 'https://via.placeholder.com/600x400?text=Tata+Punch',
                    priceHourly: 105,
                    price12hrs: 1500,
                    price24hrs: 2500,
                    description: 'Compact SUV with rugged design.',
                    category: 'premium'
                },
                {
                    id: 'car7',
                    name: 'Hyundai i20',
                    image: 'https://via.placeholder.com/600x400?text=Hyundai+i20',
                    priceHourly: 105,
                    price12hrs: 1500,
                    price24hrs: 2500,
                    description: 'Premium hatchback with sunroof.',
                    sunroof: true,
                    category: 'premium'
                },
                {
                    id: 'car8',
                    name: 'Creta',
                    image: 'https://via.placeholder.com/600x400?text=Creta',
                    priceHourly: 125,
                    price12hrs: 2000,
                    price24hrs: 3000,
                    description: 'Premium SUV with spacious cabin.',
                    category: 'premium'
                },
                {
                    id: 'car9',
                    name: 'Grand Vitara',
                    image: 'https://via.placeholder.com/600x400?text=Grand+Vitara',
                    priceHourly: 125,
                    price12hrs: 2000,
                    price24hrs: 3000,
                    description: 'Hybrid SUV with elegant design.',
                    category: 'premium'
                },
                {
                    id: 'car10',
                    name: 'Mahindra Thar',
                    image: 'https://via.placeholder.com/600x400?text=Mahindra+Thar',
                    priceHourly: 210,
                    price12hrs: 3500,
                    price24hrs: 5000,
                    description: 'Iconic off-roader.',
                    category: 'luxury'
                },
                {
                    id: 'car11',
                    name: 'Fortuner',
                    image: 'https://via.placeholder.com/600x400?text=Fortuner',
                    priceHourly: 500,
                    price12hrs: 8000,
                    price24hrs: 12000,
                    description: 'Full-size luxury SUV.',
                    withDriver: true,
                    category: 'luxury'
                },
                {
                    id: 'car12',
                    name: 'XUV700',
                    image: 'https://via.placeholder.com/600x400?text=XUV700',
                    priceHourly: 270,
                    price12hrs: 4500,
                    price24hrs: 6500,
                    description: 'Premium SUV with advanced features.',
                    withDriver: true,
                    category: 'luxury'
                }
            ];

            // Helper functions
            function showLoading() {
                loadingSpinner.style.display = 'block';
                errorMessage.textContent = '';
            }
            
            function hideLoading() {
                loadingSpinner.style.display = 'none';
            }
            
            function showError(message) {
                errorMessage.textContent = message;
            }

            function getCategoryColor(category) {
                switch(category) {
                    case 'economy': return 'success';
                    case 'premium': return 'primary';
                    case 'luxury': return 'danger';
                    default: return 'secondary';
                }
            }

            // Safe timestamp conversion helper
            function getDateFromFirestore(timestamp) {
                try {
                    // If it's a Firestore Timestamp
                    if (timestamp && typeof timestamp.toDate === 'function') {
                        return timestamp.toDate();
                    }
                    // If it's a raw timestamp object with seconds
                    if (timestamp && timestamp.seconds) {
                        return new Date(timestamp.seconds * 1000);
                    }
                    // If it's already a Date object
                    if (timestamp instanceof Date) {
                        return timestamp;
                    }
                    // If it's a string that can be parsed as a date
                    if (typeof timestamp === 'string') {
                        const date = new Date(timestamp);
                        if (!isNaN(date.getTime())) return date;
                    }
                    return null;
                } catch (e) {
                    console.error('Error converting timestamp:', e);
                    return null;
                }
            }

            // Initialize UI
            const dateFilterButtons = document.querySelectorAll('.date-filter-btn');
            const customDateInput = document.getElementById('customDateFilter');
            const applyCustomDateBtn = document.getElementById('applyCustomDate');
            const carContainers = {
                economy: document.getElementById('economyCars'),
                premium: document.getElementById('premiumCars'),
                luxury: document.getElementById('luxuryCars')
            };

            // Set default date for custom filter
            const today = new Date();
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            customDateInput.valueAsDate = today;
            customDateInput.min = today.toISOString().split('T')[0];

            // Check auth state
            auth.onAuthStateChanged(user => {
                const loginLink = document.getElementById('loginLink');
                if (user) {
                    loginLink.textContent = 'Logout';
                    loginLink.href = '#';
                    loginLink.onclick = () => {
                        auth.signOut().then(() => window.location.reload());
                    };
                } else {
                    loginLink.textContent = 'Login';
                    loginLink.href = 'login.html';
                    loginLink.onclick = null;
                }
                
                // Default: show cars available today
                filterAvailableCars('today');
            });

            // Date filter event listeners
            dateFilterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const filterType = this.getAttribute('data-filter');
                    filterAvailableCars(filterType);
                });
            });

            applyCustomDateBtn?.addEventListener('click', function() {
                if (customDateInput.value) {
                    filterAvailableCars('custom', customDateInput.value);
                } else {
                    showError('Please select a date');
                }
            });

            // Main filtering function
            async function filterAvailableCars(filterType, customDate = null) {
                showLoading();
                
                // Calculate date range based on filter type
                let startDate, endDate;
                
                const now = new Date();
                now.setHours(0, 0, 0, 0);
                
                switch(filterType) {
                    case 'today':
                        startDate = new Date(now);
                        endDate = new Date(now);
                        endDate.setDate(endDate.getDate() + 1);
                        break;
                    case 'tomorrow':
                        startDate = new Date(now);
                        startDate.setDate(startDate.getDate() + 1);
                        endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 1);
                        break;
                    case 'custom':
                        startDate = new Date(customDate);
                        startDate.setHours(0, 0, 0, 0);
                        endDate = new Date(startDate);
                        endDate.setDate(endDate.getDate() + 1);
                        break;
                    default:
                        startDate = new Date(now);
                        endDate = new Date(now);
                        endDate.setDate(endDate.getDate() + 1);
                }

                // Format dates for display
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                const dateDisplay = startDate.toLocaleDateString('en-US', options);
                document.getElementById('availabilityHeader').textContent = `Available Cars for ${dateDisplay}`;

                // Get all bookings that overlap with our date range
                let bookedCarIds = [];
                try {
                    const bookingsSnapshot = await db.collection('bookings')
                        .where('status', 'in', ['confirmed', 'active', 'pending_payment'])
                        .get();

                    bookingsSnapshot.forEach(doc => {
                        const booking = doc.data();
                        
                        // Safely get start and end dates
                        const bookingStart = getDateFromFirestore(booking.startDateTime);
                        const bookingEnd = getDateFromFirestore(booking.endDateTime);
                        
                        if (!bookingStart || !bookingEnd) {
                            console.warn('Invalid booking dates - skipping', booking);
                            return;
                        }

                        // Check if booking overlaps with our filter date range
                        if ((bookingStart < endDate) && (bookingEnd > startDate)) {
                            bookedCarIds.push(booking.carId);
                        }
                    });
                } catch (error) {
                    console.error("Error fetching bookings:", error);
                    showError("Error checking availability. Please try again.");
                } finally {
                    hideLoading();
                }

                // Filter cars to only show available ones
                const availableCars = {
                    economy: cars.filter(car => car.category === 'economy' && !bookedCarIds.includes(car.id)),
                    premium: cars.filter(car => car.category === 'premium' && !bookedCarIds.includes(car.id)),
                    luxury: cars.filter(car => car.category === 'luxury' && !bookedCarIds.includes(car.id))
                };

                // Render available cars
                renderCarCategory(availableCars.economy, carContainers.economy);
                renderCarCategory(availableCars.premium, carContainers.premium);
                renderCarCategory(availableCars.luxury, carContainers.luxury);

                // Update active filter button UI
                dateFilterButtons.forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.getAttribute('data-filter') === filterType) {
                        btn.classList.add('active');
                    }
                });
            }

            // Render function
            function renderCarCategory(carList, container) {
                if (!container) return;
                
                container.innerHTML = '';

                if (!carList || carList.length === 0) {
                    container.innerHTML = `
                        <div class="col-12 no-cars-available">
                            <div class="alert alert-info w-100 text-center">
                                No cars available in this category for selected date
                            </div>
                        </div>
                    `;
                    return;
                }

                carList.forEach((car) => {
                    const card = document.createElement('div');
                    card.className = 'col-md-4 mb-4';
                    card.innerHTML = `
                        <div class="card car-card h-100">
                            <img src="${car.image}" class="card-img-top car-img" alt="${car.name}" 
                                onerror="this.onerror=null;this.src='https://via.placeholder.com/600x400?text=Car+Image'">
                            <div class="card-body">
                                <h5 class="card-title">${car.name}</h5>
                                <p class="card-text text-muted">${car.description}</p>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div>
                                        <span class="fw-bold">₹${car.price12hrs}</span>/12h
                                        <span class="mx-2">•</span>
                                        <span class="fw-bold">₹${car.price24hrs}</span>/24h
                                    </div>
                                    <span class="badge bg-${getCategoryColor(car.category)}">${car.category}</span>
                                </div>
                                ${car.sunroof ? '<span class="badge bg-info me-1">Sunroof</span>' : ''}
                                ${car.withDriver ? '<span class="badge bg-warning">With Driver</span>' : ''}
                            </div>
                            <div class="card-footer bg-transparent">
                                <button class="btn btn-primary w-100 book-btn" data-car-id="${car.id}">Book Now</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });

                // Reattach event listeners to book buttons
                container.querySelectorAll('.book-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const carId = this.getAttribute('data-car-id');
                        const car = cars.find(c => c.id === carId);
                        if (car) showBookingModal(car);
                    });
                });
            }

            function showBookingModal(car) {
                selectedCar = car;
                document.getElementById('modalCarName').textContent = car.name;
                document.getElementById('price12hrs').textContent = car.price12hrs;
                document.getElementById('price24hrs').textContent = car.price24hrs;
                
                const user = auth.currentUser;
                if (user) {
                    document.getElementById('loginRequired').style.display = 'none';
                    document.getElementById('bookingForm').style.display = 'block';
                    document.getElementById('confirmBookingBtn').style.display = 'block';
                } else {
                    document.getElementById('loginRequired').style.display = 'block';
                    document.getElementById('bookingForm').style.display = 'none';
                    document.getElementById('confirmBookingBtn').style.display = 'none';
                }
                
                // Clear previous errors
                document.getElementById('startDateError').textContent = '';
                document.getElementById('endDateError').textContent = '';
                document.getElementById('phoneError').textContent = '';
                
                updateEstimatedTotal();
                bookingModal.show();
            }

            function updateEstimatedTotal() {
                if (!selectedCar) return;
                
                const option = document.getElementById('rentalOption').value;
                const startDateTime = document.getElementById('startDateTime').value;
                const endDateTime = document.getElementById('endDateTime').value;
                
                if (!startDateTime) return;
                
                const startDate = new Date(startDateTime);
                const endDate = new Date(endDateTime);
                
                if (isNaN(startDate.getTime())) return;
                
                if (isNaN(endDate.getTime())) {
                    // Single day booking
                    const price = option === '12hrs' ? selectedCar.price12hrs : selectedCar.price24hrs;
                    document.getElementById('estimatedTotal').textContent = price;
                    document.getElementById('billingNote').textContent = '';
                } else {
                    // Calculate total hours
                    const totalHours = (endDate - startDate) / (1000 * 60 * 60);
                    
                    // Calculate total days (rounded up)
                    const totalDays = Math.ceil(totalHours / 24);
                    
                    let totalPrice = 0;
                    let billingNote = '';
                    
                    if (totalDays >= 2) {
                        // For rentals of 2 or more days, automatically use 24-hour pricing
                        totalPrice = totalDays * selectedCar.price24hrs;
                        billingNote = `For ${totalDays} days rental, 24-hour rate (₹${selectedCar.price24hrs}/day) is applied automatically.`;
                    } else {
                        // For less than 2 days, use selected option
                        if (option === '12hrs') {
                            // Calculate in 12-hour blocks (minimum 1)
                            const blocks = Math.max(1, Math.ceil(totalHours / 12));
                            totalPrice = blocks * selectedCar.price12hrs;
                        } else {
                            // 24-hour option
                            totalPrice = selectedCar.price24hrs;
                        }
                    }
                    
                    document.getElementById('estimatedTotal').textContent = totalPrice;
                    document.getElementById('billingNote').textContent = billingNote;
                }
            }

            // Initialize date time pickers when modal shows
            bookingModal._element.addEventListener('shown.bs.modal', function() {
                // Set default start time to now (rounded to nearest hour)
                const now = new Date();
                now.setMinutes(0, 0, 0);
                const startDateTime = now.toISOString().slice(0, 16);
                document.getElementById('startDateTime').value = startDateTime;
                
                // Set default end time to same time next day
                const nextDay = new Date(now);
                nextDay.setDate(nextDay.getDate() + 1);
                const endDateTime = nextDay.toISOString().slice(0, 16);
                document.getElementById('endDateTime').value = endDateTime;
                
                // Trigger calculation
                updateEstimatedTotal();
            });

            // Event listeners for the new fields
            document.getElementById('startDateTime')?.addEventListener('change', function() {
                const startDate = new Date(this.value);
                if (isNaN(startDate.getTime())) {
                    document.getElementById('startDateError').textContent = 'Invalid start date/time';
                    return;
                }
                document.getElementById('startDateError').textContent = '';
                
                // Set minimum end date time to 1 hour after start
                const minEndDate = new Date(startDate);
                minEndDate.setHours(minEndDate.getHours() + 1);
                document.getElementById('endDateTime').min = minEndDate.toISOString().slice(0, 16);
                
                updateEstimatedTotal();
            });

            document.getElementById('endDateTime')?.addEventListener('change', function() {
                const endDate = new Date(this.value);
                if (isNaN(endDate.getTime())) {
                    document.getElementById('endDateError').textContent = 'Invalid end date/time';
                    return;
                }
                document.getElementById('endDateError').textContent = '';
                updateEstimatedTotal();
            });

            document.getElementById('rentalOption')?.addEventListener('change', updateEstimatedTotal);
            
            // Phone number validation
            document.getElementById('phoneNumber')?.addEventListener('input', function() {
                this.value = this.value.replace(/\D/g, '').slice(0, 10);
                if (this.value.length !== 10) {
                    document.getElementById('phoneError').textContent = 'Please enter a 10-digit number';
                } else {
                    document.getElementById('phoneError').textContent = '';
                }
            });

            // Confirm booking
            document.getElementById('confirmBookingBtn')?.addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) {
                    alert('Please login to complete booking');
                    return;
                }

                const phoneNumber = document.getElementById('phoneNumber').value;
                const startDateTime = document.getElementById('startDateTime').value;
                const endDateTime = document.getElementById('endDateTime').value;
                const option = document.getElementById('rentalOption').value;
                
                // Validate inputs
                let isValid = true;
                
                if (!phoneNumber || phoneNumber.length !== 10) {
                    document.getElementById('phoneError').textContent = 'Please enter a valid 10-digit phone number';
                    isValid = false;
                }
                
                const startDate = new Date(startDateTime);
                if (isNaN(startDate.getTime())) {
                    document.getElementById('startDateError').textContent = 'Please select a valid start date/time';
                    isValid = false;
                }
                
                const endDate = new Date(endDateTime);
                if (isNaN(endDate.getTime())) {
                    document.getElementById('endDateError').textContent = 'Please select a valid end date/time';
                    isValid = false;
                }
                
                if (!isValid) return;
                
                // Validate end date is after start date
                if (endDate <= startDate) {
                    document.getElementById('endDateError').textContent = 'End date/time must be after start date/time';
                    return;
                }

                // Check if car is available
                try {
                    const isAvailable = await isCarAvailable(selectedCar.id, startDateTime, endDateTime);
                    if (!isAvailable) {
                        alert('This car is already booked for the selected time period. Please choose different dates/times.');
                        return;
                    }

                    const totalHours = (endDate - startDate) / (1000 * 60 * 60);
                    const totalDays = Math.ceil(totalHours / 24);
                    
                    let pricePerUnit, finalPrice, billingType;
                    
                    if (totalDays >= 2) {
                        // For 2+ days, use 24-hour pricing
                        pricePerUnit = selectedCar.price24hrs;
                        finalPrice = totalDays * pricePerUnit;
                        billingType = '24hr_auto';
                    } else {
                        // For less than 2 days, use selected option
                        if (option === '12hrs') {
                            pricePerUnit = selectedCar.price12hrs;
                            const blocks = Math.max(1, Math.ceil(totalHours / 12));
                            finalPrice = blocks * pricePerUnit;
                            billingType = '12hr';
                        } else {
                            pricePerUnit = selectedCar.price24hrs;
                            finalPrice = pricePerUnit;
                            billingType = '24hr';
                        }
                    }

                    const bookingId = 'BOOK-' + Math.random().toString(36).substr(2, 8).toUpperCase();

                    await db.collection('bookings').doc(bookingId).set({
                        userId: user.uid,
                        userEmail: user.email,
                        userPhone: phoneNumber,
                        carId: selectedCar.id,
                        carName: selectedCar.name,
                        carImage: selectedCar.image,
                        startDateTime: firebase.firestore.Timestamp.fromDate(new Date(startDateTime)),
                        endDateTime: firebase.firestore.Timestamp.fromDate(new Date(endDateTime)),
                        rentalOption: option,
                        originalPrice: pricePerUnit,
                        finalPrice: finalPrice,
                        status: 'pending_payment',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        bookingId: bookingId,
                        billingType: billingType,
                        totalDays: totalDays,
                        totalHours: totalHours
                    });
                    
                    bookingModal.hide();
                    alert(`Booking successful! Your booking ID is ${bookingId}`);
                    window.location.href = `pay.html?bookingId=${bookingId}`;
                } catch (error) {
                    console.error('Booking error:', error);
                    alert('Error submitting booking: ' + error.message);
                }
            });

            // Function to check car availability
            async function isCarAvailable(carId, startDateTime, endDateTime) {
                try {
                    const bookingsRef = db.collection('bookings');
                    const snapshot = await bookingsRef
                        .where('carId', '==', carId)
                        .where('status', 'in', ['pending_payment', 'confirmed', 'active'])
                        .get();

                    const newStart = new Date(startDateTime);
                    const newEnd = new Date(endDateTime);

                    for (const doc of snapshot.docs) {
                        const booking = doc.data();
                        
                        // Use the safe date conversion helper
                        const existingStart = getDateFromFirestore(booking.startDateTime);
                        const existingEnd = getDateFromFirestore(booking.endDateTime);
                        
                        if (!existingStart || !existingEnd) {
                            console.warn('Invalid booking dates - skipping', booking);
                            continue;
                        }

                        // Check for overlap
                        if ((newStart >= existingStart && newStart < existingEnd) ||
                            (newEnd > existingStart && newEnd <= existingEnd) ||
                            (newStart <= existingStart && newEnd >= existingEnd)) {
                            return false; // Car is not available
                        }
                    }
                    return true; // Car is available
                } catch (error) {
                    console.error('Error checking availability:', error);
                    return false; // Assume not available if there's an error
                }
            }
        });
    </script>
</body>
</html>
