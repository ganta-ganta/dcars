<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | GoPandaCars</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar { min-height: 100vh; }
    .nav-link { color: #333; }
    .nav-link.active { color: #0d6efd; font-weight: 500; }
    .badge-status { font-size: 0.8rem; }
    .booking-card { transition: all 0.3s; }
    .booking-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4>GoPandaCars</h4>
            <hr>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-bs-target="dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="bookings">
                <i class="fas fa-calendar-check me-2"></i>Bookings
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="offers">
                <i class="fas fa-tag me-2"></i>Offers
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="cars">
                <i class="fas fa-car me-2"></i>Cars
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="users">
                <i class="fas fa-users me-2"></i>Users
              </a>
            </li>
            <li class="nav-item mt-4">
              <a class="nav-link text-danger" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Admin Dashboard</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
              <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
            </div>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection">
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                  <h5 class="card-title">Total Bookings</h5>
                  <h2 class="card-text" id="totalBookings">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success mb-3">
                <div class="card-body">
                  <h5 class="card-title">Confirmed</h5>
                  <h2 class="card-text" id="confirmedBookings">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                  <h5 class="card-title">Pending</h5>
                  <h2 class="card-text" id="pendingBookings">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                  <h5 class="card-title">Cancelled</h5>
                  <h2 class="card-text" id="cancelledBookings">0</h2>
                </div>
              </div>
            </div>
          </div>

          <h4>Recent Bookings</h4>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Car</th>
                  <th>Customer</th>
                  <th>Dates</th>
                  <th>Status</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="recentBookingsTable">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookingsSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Manage Bookings</h4>
            <div class="btn-group">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item filter-booking" data-status="all" href="#">All</a></li>
                <li><a class="dropdown-item filter-booking" data-status="pending_payment" href="#">Pending Payment</a></li>
                <li><a class="dropdown-item filter-booking" data-status="confirmed" href="#">Confirmed</a></li>
                <li><a class="dropdown-item filter-booking" data-status="cancelled" href="#">Cancelled</a></li>
              </ul>
            </div>
          </div>
          <div class="row" id="bookingsGrid">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>

        <!-- Offers Section -->
        <div id="offersSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Manage Offers</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOfferModal">
              <i class="fas fa-plus me-1"></i> Add New Offer
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Discount</th>
                  <th>Valid Until</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="offersList">
                <!-- Offers will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cars Section -->
        <div id="carsSection" style="display: none;">
          <h4>Manage Cars</h4>
          <p>Cars management coming soon...</p>
        </div>

        <!-- Users Section -->
        <div id="usersSection" style="display: none;">
          <h4>Manage Users</h4>
          <p>Users management coming soon...</p>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Offer Modal -->
  <div class="modal fade" id="addOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="offerForm">
            <div class="mb-3">
              <label class="form-label">Offer Code</label>
              <input type="text" class="form-control" id="offerCode" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Offer Name</label>
              <input type="text" class="form-control" id="offerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="offerDescription" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Type</label>
                <select class="form-select" id="discountType" required>
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Value</label>
                <input type="number" class="form-control" id="discountValue" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Valid Until</label>
              <input type="date" class="form-control" id="validUntil" required>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="isActive" checked>
              <label class="form-check-label" for="isActive">Active</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveOfferBtn" class="btn btn-primary">Save Offer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bookingModalBody">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="cancelBookingBtn" style="display:none;">Cancel Booking</button>
          <button type="button" class="btn btn-success" id="confirmBookingBtn" style="display:none;">Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
      authDomain: "gopandacars-7085f.firebaseapp.com",
      projectId: "gopandacars-7085f",
      storageBucket: "gopandacars-7085f.appspot.com",
      messagingSenderId: "486383420605"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardSection = document.getElementById('dashboardSection');
    const bookingsSection = document.getElementById('bookingsSection');
    const offersSection = document.getElementById('offersSection');
    const carsSection = document.getElementById('carsSection');
    const usersSection = document.getElementById('usersSection');
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
    const addOfferModal = new bootstrap.Modal(document.getElementById('addOfferModal'));
    let currentBookingId = null;

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        if (user.email === 'ramakrishnasaiganta@gmail.com') {
          // Admin user
          loadDashboard();
          loadOffers();
          setupEventListeners();
        } else {
          // Not admin
          window.location.href = 'profile.html';
        }
      } else {
        // No user signed in
        window.location.href = 'login.html';
      }
    });

    // Load dashboard data
    function loadDashboard() {
      // Load booking counts
      db.collection('bookings').get().then(snap => {
        document.getElementById('totalBookings').textContent = snap.size;
        
        const confirmed = snap.docs.filter(doc => doc.data().status === 'confirmed').length;
        const pending = snap.docs.filter(doc => doc.data().status === 'pending_payment').length;
        const cancelled = snap.docs.filter(doc => doc.data().status === 'cancelled').length;
        
        document.getElementById('confirmedBookings').textContent = confirmed;
        document.getElementById('pendingBookings').textContent = pending;
        document.getElementById('cancelledBookings').textContent = cancelled;
      });
      
      // Load recent bookings
      db.collection('bookings').orderBy('createdAt', 'desc').limit(5).get()
        .then(snap => {
          const tableBody = document.getElementById('recentBookingsTable');
          tableBody.innerHTML = '';
          
          snap.forEach(doc => {
            const booking = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${doc.id.substring(0, 6)}...</td>
              <td>${booking.carId}</td>
              <td>${booking.userEmail}</td>
              <td>${booking.startDate} to ${booking.endDate}</td>
              <td><span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status}</span></td>
              <td>₹${booking.finalPrice || booking.originalPrice}</td>
            `;
            tableBody.appendChild(row);
          });
        });
    }

    // Load all bookings
    function loadAllBookings(filter = 'all') {
      let query = db.collection('bookings').orderBy('createdAt', 'desc');
      
      if (filter !== 'all') {
        query = query.where('status', '==', filter);
      }
      
      // Use onSnapshot for real-time updates
      query.onSnapshot(snap => {
        const bookingsGrid = document.getElementById('bookingsGrid');
        bookingsGrid.innerHTML = '';
        
        if (snap.empty) {
          bookingsGrid.innerHTML = '<div class="col-12 text-center py-5"><h6 class="text-muted">No bookings found</h6></div>';
          return;
        }
        
        snap.forEach(doc => {
          const booking = doc.data();
          addBookingCard(booking, doc.id);
        });
      }, error => {
        console.error("Error getting bookings: ", error);
      });
    }

    function addBookingCard(booking, bookingId) {
      const card = document.createElement('div');
      card.className = 'col-md-6 col-lg-4 mb-4';
      
      card.innerHTML = `
        <div class="card booking-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h5 class="card-title mb-0">${booking.carId}</h5>
              <span class="badge ${getStatusBadgeClass(booking.status)} badge-status">${booking.status}</span>
            </div>
            <p class="card-text text-muted mb-1"><small>${booking.userEmail}</small></p>
            <p class="card-text mb-2">${booking.startDate} to ${booking.endDate}</p>
            <p class="card-text fw-bold">₹${booking.finalPrice || booking.originalPrice}</p>
          </div>
          <div class="card-footer bg-transparent">
            <button class="btn btn-sm btn-outline-primary view-booking" data-booking-id="${bookingId}">
              <i class="fas fa-eye me-1"></i> View
            </button>
            ${booking.status === 'pending_payment' ? `
              <button class="btn btn-sm btn-success confirm-booking ms-2" data-booking-id="${bookingId}">
                <i class="fas fa-check me-1"></i> Confirm
              </button>
            ` : ''}
          </div>
        </div>
      `;
      
      document.getElementById('bookingsGrid').appendChild(card);
    }

    // Load offers
    function loadOffers() {
      db.collection('offers').orderBy('createdAt', 'desc').onSnapshot(snap => {
        const offersList = document.getElementById('offersList');
        offersList.innerHTML = '';
        
        snap.forEach(doc => {
          const offer = doc.data();
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${offer.code}</td>
            <td>${offer.name}</td>
            <td>
              ${offer.discountType === 'percentage' ? 
                `${offer.discountValue}%` : 
                `₹${offer.discountValue}`}
            </td>
            <td>${new Date(offer.validUntil).toLocaleDateString()}</td>
            <td>
              <span class="badge ${offer.isActive ? 'bg-success' : 'bg-secondary'}">
                ${offer.isActive ? 'Active' : 'Inactive'}
              </span>
            </td>
            <td>
              <button class="btn btn-sm btn-outline-primary toggle-offer" 
                      data-offer-id="${doc.id}" 
                      data-current-status="${offer.isActive}">
                ${offer.isActive ? 'Deactivate' : 'Activate'}
              </button>
              <button class="btn btn-sm btn-outline-danger delete-offer ms-1" 
                      data-offer-id="${doc.id}">
                <i class="fas fa-trash"></i>
              </button>
            </td>
          `;
          offersList.appendChild(row);
        });
      });
    }

    // Save new offer
    function saveOffer() {
      const offer = {
        code: document.getElementById('offerCode').value,
        name: document.getElementById('offerName').value,
        description: document.getElementById('offerDescription').value,
        discountType: document.getElementById('discountType').value,
        discountValue: parseFloat(document.getElementById('discountValue').value),
        validUntil: document.getElementById('validUntil').value,
        isActive: document.getElementById('isActive').checked,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection('offers').add(offer)
        .then(() => {
          alert('Offer created successfully!');
          addOfferModal.hide();
          document.getElementById('offerForm').reset();
        })
        .catch(error => {
          alert('Error creating offer: ' + error.message);
        });
    }

    function getStatusBadgeClass(status) {
      switch(status) {
        case 'confirmed': return 'bg-success';
        case 'pending_payment': return 'bg-warning';
        case 'cancelled': return 'bg-danger';
        default: return 'bg-secondary';
      }
    }

    // View booking details
    function viewBookingDetails(bookingId) {
      currentBookingId = bookingId;
      db.collection('bookings').doc(bookingId).get().then(doc => {
        if (doc.exists) {
          const booking = doc.data();
          const modalBody = document.getElementById('bookingModalBody');
          
          modalBody.innerHTML = `
            <div class="row">
              <div class="col-md-6">
                <h6>Booking Information</h6>
                <p><strong>ID:</strong> ${doc.id}</p>
                <p><strong>Car:</strong> ${booking.carId}</p>
                <p><strong>Dates:</strong> ${booking.startDate} to ${booking.endDate}</p>
                <p><strong>Original Price:</strong> ₹${booking.originalPrice}</p>
                <p><strong>Final Price:</strong> ₹${booking.finalPrice || booking.originalPrice}</p>
                <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status}</span></p>
                <p><strong>Booked On:</strong> ${booking.createdAt?.toDate().toLocaleString()}</p>
              </div>
              <div class="col-md-6">
                <h6>Customer Information</h6>
                <p><strong>Email:</strong> ${booking.userEmail}</p>
                <p><strong>User ID:</strong> ${booking.userId}</p>
                ${booking.appliedOffer ? `
                  <h6 class="mt-3">Applied Offer</h6>
                  <p><strong>Code:</strong> ${booking.appliedOffer}</p>
                ` : ''}
              </div>
            </div>
          `;
          
          // Show/hide action buttons based on status
          document.getElementById('cancelBookingBtn').style.display = booking.status === 'confirmed' || booking.status === 'pending_payment' ? 'block' : 'none';
          document.getElementById('confirmBookingBtn').style.display = booking.status === 'pending_payment' ? 'block' : 'none';
          
          bookingModal.show();
        }
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Update active nav link
          document.querySelectorAll('.nav-link').forEach(navLink => {
            navLink.classList.remove('active');
          });
          this.classList.add('active');
          
          // Show corresponding section
          const target = this.getAttribute('data-bs-target');
          dashboardSection.style.display = 'none';
          bookingsSection.style.display = 'none';
          offersSection.style.display = 'none';
          carsSection.style.display = 'none';
          usersSection.style.display = 'none';
          
          if (target === 'dashboard') {
            dashboardSection.style.display = 'block';
            loadDashboard();
          } else if (target === 'bookings') {
            bookingsSection.style.display = 'block';
            loadAllBookings();
          } else if (target === 'offers') {
            offersSection.style.display = 'block';
          } else if (target === 'cars') {
            carsSection.style.display = 'block';
          } else if (target === 'users') {
            usersSection.style.display = 'block';
          }
        });
      });
      
      // Booking filter
      document.querySelectorAll('.filter-booking').forEach(filter => {
        filter.addEventListener('click', function(e) {
          e.preventDefault();
          const status = this.getAttribute('data-status');
          loadAllBookings(status);
        });
      });
      
      // View booking buttons (event delegation)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('view-booking')) {
          const bookingId = e.target.getAttribute('data-booking-id');
          viewBookingDetails(bookingId);
        }
        
        if (e.target.classList.contains('confirm-booking')) {
          const bookingId = e.target.getAttribute('data-booking-id');
          if (confirm('Are you sure you want to confirm this booking?')) {
            db.collection('bookings').doc(bookingId).update({
              status: 'confirmed',
              confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
            }).catch(error => {
              alert('Error confirming booking: ' + error.message);
            });
          }
        }
      });
      
      // Offer actions (event delegation)
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('toggle-offer')) {
          const offerId = e.target.getAttribute('data-offer-id');
          const currentStatus = e.target.getAttribute('data-current-status') === 'true';
          
          db.collection('offers').doc(offerId).update({
            isActive: !currentStatus
          }).catch(error => {
            alert('Error updating offer: ' + error.message);
          });
        }
        
        if (e.target.classList.contains('delete-offer')) {
          const offerId = e.target.getAttribute('data-offer-id');
          
          if (confirm('Are you sure you want to delete this offer?')) {
            db.collection('offers').doc(offerId).delete()
              .catch(error => {
                alert('Error deleting offer: ' + error.message);
              });
          }
        }
      });
      
      // Booking actions
      document.getElementById('cancelBookingBtn').addEventListener('click', () => {
        if (confirm('Are you sure you want to cancel this booking?')) {
          db.collection('bookings').doc(currentBookingId).update({
            status: 'cancelled'
          }).then(() => {
            alert('Booking cancelled successfully');
            bookingModal.hide();
          });
        }
      });
      
      document.getElementById('confirmBookingBtn').addEventListener('click', () => {
        db.collection('bookings').doc(currentBookingId).update({
          status: 'confirmed',
          confirmedAt: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
          alert('Booking confirmed successfully');
          bookingModal.hide();
        });
      });
      
      // Save offer
      document.getElementById('saveOfferBtn').addEventListener('click', saveOffer);
      
      // Logout
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'index.html';
        });
      });
    }
  </script>
</body>
</html>
