<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | GoPandaCars</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar { min-height: 100vh; background-color: #f8f9fa; }
    .nav-link { color: #333; }
    .nav-link.active { color: #0d6efd; font-weight: 500; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
    .loading-spinner { height: 200px; display: flex; justify-content: center; align-items: center; }
    .badge-active { background-color: #28a745; }
    .badge-inactive { background-color: #6c757d; }
    .badge-blocked { background-color: #dc3545; }
    .badge-admin { background-color: #0d6efd; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4>GoPandaCars</h4>
            <hr>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link" href="#" data-target="dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-target="bookings">
                <i class="fas fa-calendar-check me-2"></i>Bookings
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="#" data-target="users">
                <i class="fas fa-users me-2"></i>Users
              </a>
            </li>
            <li class="nav-item mt-4">
              <a class="nav-link text-danger" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">User Management</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-filter me-1"></i> Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item filter-user" href="#" data-status="all">All Users</a></li>
                <li><a class="dropdown-item filter-user" href="#" data-status="active">Active</a></li>
                <li><a class="dropdown-item filter-user" href="#" data-status="inactive">Inactive</a></li>
                <li><a class="dropdown-item filter-user" href="#" data-status="blocked">Blocked</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item filter-user" href="#" data-status="admin">Admins</a></li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Users Table -->
        <div class="table-responsive">
          <table class="table table-striped table-hover align-middle">
            <thead>
              <tr>
                <th>User</th>
                <th>Contact</th>
                <th>Registration</th>
                <th>License</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              <tr>
                <td colspan="6" class="text-center loading-spinner">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading users...</p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </main>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="userModalBody">
          Loading user details...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="blockUserBtn">Block User</button>
          <button type="button" class="btn btn-success" id="unblockUserBtn" style="display:none;">Unblock User</button>
          <button type="button" class="btn btn-primary" id="makeAdminBtn" style="display:none;">Make Admin</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
      authDomain: "gopandacars-7085f.firebaseapp.com",
      projectId: "gopandacars-7085f",
      storageBucket: "gopandacars-7085f.appspot.com",
      messagingSenderId: "486383420605"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const logoutBtn = document.getElementById('logoutBtn');
    const usersTableBody = document.getElementById('usersTableBody');
    const userModal = new bootstrap.Modal('#userModal');
    let currentUserId = null;
    let unsubscribeUsers = null;
    let currentFilter = 'all';

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        checkAdminStatus(user.uid);
      } else {
        window.location.href = 'login.html';
      }
    });

    // Check if user is admin
    function checkAdminStatus(userId) {
      db.collection('users').doc(userId).get()
        .then(doc => {
          if (doc.exists && (doc.data().role === 'admin' || doc.data().email === 'admin@gopandacars.in')) {
            // User is admin, load data
            loadUsers();
            setupEventListeners();
          } else {
            // Not admin, redirect
            window.location.href = 'profile.html';
          }
        })
        .catch(error => {
          console.error("Error checking admin status:", error);
          window.location.href = 'login.html';
        });
    }

    // Load users with real-time updates
    function loadUsers(filter = 'all') {
      currentFilter = filter;
      
      // Clear any existing listeners
      if (unsubscribeUsers) {
        unsubscribeUsers();
      }

      let query = db.collection('users').orderBy('createdAt', 'desc');

      // Apply filters
      switch(filter) {
        case 'active':
          query = query.where('status', '==', 'active');
          break;
        case 'inactive':
          query = query.where('status', '==', 'inactive');
          break;
        case 'blocked':
          query = query.where('isBlocked', '==', true);
          break;
        case 'admin':
          query = query.where('role', '==', 'admin');
          break;
        // 'all' shows all users
      }

      // Show loading state
      usersTableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center loading-spinner">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading users...</p>
          </td>
        </tr>
      `;

      // Set up real-time listener
      unsubscribeUsers = query.onSnapshot(snapshot => {
        usersTableBody.innerHTML = '';

        if (snapshot.empty) {
          usersTableBody.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-5">
                <h6 class="text-muted">No users found</h6>
                ${filter !== 'all' ? '<p>Try changing your filter</p>' : ''}
              </td>
            </tr>
          `;
          return;
        }

        snapshot.forEach(doc => {
          const user = doc.data();
          const userId = doc.id;
          addUserRow(user, userId);
        });
      }, error => {
        console.error("Error loading users:", error);
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-5 text-danger">
              Error loading users: ${error.message}
              <button class="btn btn-sm btn-primary mt-2" onclick="loadUsers('${currentFilter}')">
                <i class="fas fa-sync-alt me-1"></i> Try Again
              </button>
            </td>
          </tr>
        `;
      });
    }

    // Add user row to table
    function addUserRow(user, userId) {
      const row = document.createElement('tr');
      
      // Determine status badge
      let statusBadge = '';
      if (user.isBlocked) {
        statusBadge = '<span class="badge badge-blocked">Blocked</span>';
      } else if (user.status === 'active') {
        statusBadge = '<span class="badge badge-active">Active</span>';
      } else {
        statusBadge = '<span class="badge badge-inactive">Inactive</span>';
      }
      
      // Add role badge if admin
      const roleBadge = user.role === 'admin' ? '<span class="badge badge-admin ms-1">Admin</span>' : '';
      
      // Format registration date
      const regDate = user.createdAt?.toDate ? user.createdAt.toDate().toLocaleDateString() : 'N/A';
      
      // Create row HTML
      row.innerHTML = `
        <td>
          <div class="d-flex align-items-center">
            <img src="${user.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'U')}&background=random`}" 
                 class="user-avatar me-3" alt="${user.name}">
            <div>
              <h6 class="mb-0">${user.name || 'No name'}</h6>
              <small class="text-muted">${user.email}</small>
            </div>
          </div>
        </td>
        <td>
          ${user.phone || '<span class="text-muted">Not provided</span>'}
        </td>
        <td>
          ${regDate}
        </td>
        <td>
          ${user.driverLicense ? user.driverLicense.substring(0, 6) + '...' : '<span class="text-muted">Not provided</span>'}
        </td>
        <td>
          ${statusBadge}
          ${roleBadge}
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-user" data-user-id="${userId}">
            <i class="fas fa-eye me-1"></i> View
          </button>
          ${!user.isBlocked ? `
            <button class="btn btn-sm btn-outline-danger block-user ms-1" data-user-id="${userId}">
              <i class="fas fa-ban me-1"></i> Block
            </button>
          ` : `
            <button class="btn btn-sm btn-outline-success unblock-user ms-1" data-user-id="${userId}">
              <i class="fas fa-check-circle me-1"></i> Unblock
            </button>
          `}
          ${user.role !== 'admin' ? `
            <button class="btn btn-sm btn-outline-info make-admin ms-1" data-user-id="${userId}">
              <i class="fas fa-user-shield me-1"></i> Make Admin
            </button>
          ` : ''}
        </td>
      `;
      
      usersTableBody.appendChild(row);
    }

    // Setup event listeners
    function setupEventListeners() {
      // Logout
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      });

      // Filter users
      document.querySelectorAll('.filter-user').forEach(filter => {
        filter.addEventListener('click', (e) => {
          e.preventDefault();
          const status = filter.getAttribute('data-status');
          loadUsers(status);
        });
      });

      // View user details
      document.addEventListener('click', (e) => {
        if (e.target.closest('.view-user')) {
          const userId = e.target.closest('.view-user').getAttribute('data-user-id');
          viewUserDetails(userId);
        }
        
        // Block user
        if (e.target.closest('.block-user')) {
          const userId = e.target.closest('.block-user').getAttribute('data-user-id');
          blockUser(userId);
        }
        
        // Unblock user
        if (e.target.closest('.unblock-user')) {
          const userId = e.target.closest('.unblock-user').getAttribute('data-user-id');
          unblockUser(userId);
        }
        
        // Make admin
        if (e.target.closest('.make-admin')) {
          const userId = e.target.closest('.make-admin').getAttribute('data-user-id');
          makeAdmin(userId);
        }
      });

      // Block user from modal
      document.getElementById('blockUserBtn').addEventListener('click', () => {
        if (currentUserId) {
          blockUser(currentUserId);
        }
      });

      // Unblock user from modal
      document.getElementById('unblockUserBtn').addEventListener('click', () => {
        if (currentUserId) {
          unblockUser(currentUserId);
        }
      });

      // Make admin from modal
      document.getElementById('makeAdminBtn').addEventListener('click', () => {
        if (currentUserId) {
          makeAdmin(currentUserId);
        }
      });
    }

    // View user details
    async function viewUserDetails(userId) {
      currentUserId = userId;
      
      try {
        const doc = await db.collection('users').doc(userId).get();
        if (!doc.exists) {
          alert('User not found');
          return;
        }
        
        const user = doc.data();
        const modalBody = document.getElementById('userModalBody');
        
        // Format dates
        const createdAt = user.createdAt?.toDate ? user.createdAt.toDate().toLocaleString() : 'N/A';
        const updatedAt = user.updatedAt?.toDate ? user.updatedAt.toDate().toLocaleString() : 'N/A';
        
        modalBody.innerHTML = `
          <div class="row">
            <div class="col-md-4 text-center mb-4">
              <img src="${user.profilePic || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || 'U')}&size=150&background=random`}" 
                   class="img-fluid rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;" alt="Profile">
              <h4>${user.name || 'No name'}</h4>
              <p class="text-muted">${user.email}</p>
              <span class="badge ${user.isBlocked ? 'badge-blocked' : user.status === 'active' ? 'badge-active' : 'badge-inactive'}">
                ${user.isBlocked ? 'Blocked' : user.status || 'inactive'}
              </span>
              ${user.role === 'admin' ? '<span class="badge badge-admin ms-1">Admin</span>' : ''}
            </div>
            <div class="col-md-8">
              <div class="row">
                <div class="col-md-6">
                  <h5 class="mb-3">Basic Information</h5>
                  <p><strong>User ID:</strong> ${userId.substring(0, 8)}...</p>
                  <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                  <p><strong>License:</strong> ${user.driverLicense || 'Not provided'}</p>
                </div>
                <div class="col-md-6">
                  <h5 class="mb-3">Account Details</h5>
                  <p><strong>Created:</strong> ${createdAt}</p>
                  <p><strong>Last Updated:</strong> ${updatedAt}</p>
                  <p><strong>Email Verified:</strong> ${user.emailVerified ? 'Yes' : 'No'}</p>
                </div>
              </div>
              <hr>
              <div class="row mt-3">
                <div class="col-12">
                  <h5 class="mb-3">Activity</h5>
                  <p><strong>Total Bookings:</strong> ${user.totalBookings || 0}</p>
                  <p><strong>Last Booking:</strong> ${user.lastBookingDate ? new Date(user.lastBookingDate).toLocaleDateString() : 'Never'}</p>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // Show appropriate action buttons
        document.getElementById('blockUserBtn').style.display = 'none';
        document.getElementById('unblockUserBtn').style.display = 'none';
        document.getElementById('makeAdminBtn').style.display = 'none';
        
        if (user.isBlocked) {
          document.getElementById('unblockUserBtn').style.display = 'inline-block';
        } else {
          document.getElementById('blockUserBtn').style.display = 'inline-block';
        }
        
        if (user.role !== 'admin') {
          document.getElementById('makeAdminBtn').style.display = 'inline-block';
        }
        
        userModal.show();
      } catch (error) {
        console.error("Error loading user details:", error);
        document.getElementById('userModalBody').innerHTML = `
          <div class="alert alert-danger">
            Error loading user details: ${error.message}
          </div>
        `;
        userModal.show();
      }
    }

    // Block user
    function blockUser(userId) {
      if (!confirm('Are you sure you want to block this user? They will not be able to log in.')) return;
      
      db.collection('users').doc(userId).update({
        isBlocked: true,
        status: 'inactive',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User blocked successfully');
        userModal.hide();
      })
      .catch(error => {
        console.error("Error blocking user:", error);
        alert('Failed to block user: ' + error.message);
      });
    }

    // Unblock user
    function unblockUser(userId) {
      if (!confirm('Are you sure you want to unblock this user?')) return;
      
      db.collection('users').doc(userId).update({
        isBlocked: false,
        status: 'active',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User unblocked successfully');
        userModal.hide();
      })
      .catch(error => {
        console.error("Error unblocking user:", error);
        alert('Failed to unblock user: ' + error.message);
      });
    }

    // Make user admin
    function makeAdmin(userId) {
      if (!confirm('Are you sure you want to make this user an admin? They will have full access to the admin dashboard.')) return;
      
      db.collection('users').doc(userId).update({
        role: 'admin',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User is now an admin');
        userModal.hide();
      })
      .catch(error => {
        console.error("Error making user admin:", error);
        alert('Failed to make user admin: ' + error.message);
      });
    }
  </script>
</body>
</html>
