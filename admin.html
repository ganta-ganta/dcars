<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | GoPandaCars</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar { min-height: 100vh; }
    .nav-link { color: #333; }
    .nav-link.active { color: #0d6efd; font-weight: 500; }
    .badge-status { font-size: 0.8rem; }
    .booking-card { transition: all 0.3s; }
    .booking-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar collapse">
        <div class="position-sticky pt-3">
          <div class="text-center mb-4">
            <h4>GoPandaCars</h4>
            <hr>
          </div>
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-bs-target="dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="bookings">
                <i class="fas fa-calendar-check me-2"></i>Bookings
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="users">
                <i class="fas fa-users me-2"></i>Users
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="offers">
                <i class="fas fa-tag me-2"></i>Offers
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-bs-target="cars">
                <i class="fas fa-car me-2"></i>Cars
              </a>
            </li>
            <li class="nav-item mt-4">
              <a class="nav-link text-danger" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2">Admin Dashboard</h1>
          <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
              <button type="button" class="btn btn-sm btn-outline-secondary">Share</button>
              <button type="button" class="btn btn-sm btn-outline-secondary">Export</button>
            </div>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection">
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-white bg-primary mb-3">
                <div class="card-body">
                  <h5 class="card-title">Total Bookings</h5>
                  <h2 class="card-text" id="totalBookings">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success mb-3">
                <div class="card-body">
                  <h5 class="card-title">Confirmed</h5>
                  <h2 class="card-text" id="confirmedBookings">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning mb-3">
                <div class="card-body">
                  <h5 class="card-title">Pending</h5>
                  <h2 class="card-text" id="pendingBookings">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-danger mb-3">
                <div class="card-body">
                  <h5 class="card-title">Cancelled</h5>
                  <h2 class="card-text" id="cancelledBookings">0</h2>
                </div>
              </div>
            </div>
          </div>

          <h4>Recent Bookings</h4>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Car</th>
                  <th>Customer</th>
                  <th>Dates</th>
                  <th>Status</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody id="recentBookingsTable">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookingsSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Manage Bookings</h4>
            <div class="btn-group">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item filter-booking" data-status="all" href="#">All</a></li>
                <li><a class="dropdown-item filter-booking" data-status="pending_payment" href="#">Pending Payment</a></li>
                <li><a class="dropdown-item filter-booking" data-status="confirmed" href="#">Confirmed</a></li>
                <li><a class="dropdown-item filter-booking" data-status="cancelled" href="#">Cancelled</a></li>
              </ul>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Booking ID</th>
                  <th>Car</th>
                  <th>Customer</th>
                  <th>Dates</th>
                  <th>Status</th>
                  <th>Amount</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="bookingsList">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Manage Users</h4>
            <div class="btn-group">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Filter
              </button>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item filter-user" data-status="all" href="#">All</a></li>
                <li><a class="dropdown-item filter-user" data-status="active" href="#">Active</a></li>
                <li><a class="dropdown-item filter-user" data-status="blocked" href="#">Blocked</a></li>
              </ul>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>User ID</th>
                  <th>Email</th>
                  <th>Joined</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersList">
                <!-- Will be populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Offers Section -->
        <div id="offersSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Manage Offers</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOfferModal">
              <i class="fas fa-plus me-1"></i> Add New Offer
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Name</th>
                  <th>Discount</th>
                  <th>Valid Until</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="offersList">
                <!-- Offers will be loaded here -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cars Section -->
        <div id="carsSection" style="display: none;">
          <div class="d-flex justify-content-between mb-3">
            <h4>Manage Cars</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCarModal">
              <i class="fas fa-plus me-1"></i> Add New Car
            </button>
          </div>
          <div class="row" id="carsGrid">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Offer Modal -->
  <div class="modal fade" id="addOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="offerForm">
            <div class="mb-3">
              <label class="form-label">Offer Code</label>
              <input type="text" class="form-control" id="offerCode" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Offer Name</label>
              <input type="text" class="form-control" id="offerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="offerDescription" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Type</label>
                <select class="form-select" id="discountType" required>
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Value</label>
                <input type="number" class="form-control" id="discountValue" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Valid Until</label>
              <input type="date" class="form-control" id="validUntil" required>
            </div>
            <div class="form-check mb-3">
              <input class="form-check-input" type="checkbox" id="isActive" checked>
              <label class="form-check-label" for="isActive">Active</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveOfferBtn" class="btn btn-primary">Save Offer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Car Modal -->
  <div class="modal fade" id="addCarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Car</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="carForm">
            <div class="mb-3">
              <label class="form-label">Car Name</label>
              <input type="text" class="form-control" id="carName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Image URL</label>
              <input type="url" class="form-control" id="carImage" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="carDescription" rows="3" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Category</label>
                <select class="form-select" id="carCategory" required>
                  <option value="economy">Economy</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">12 Hours Price (₹)</label>
                <input type="number" class="form-control" id="carPrice12hrs" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">24 Hours Price (₹)</label>
                <input type="number" class="form-control" id="carPrice24hrs" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Features</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="carSunroof">
                  <label class="form-check-label" for="carSunroof">Sunroof</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="carWithDriver">
                  <label class="form-check-label" for="carWithDriver">With Driver</label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveCarBtn" class="btn btn-primary">Save Car</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bookingModalBody">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="cancelBookingBtn" style="display:none;">Cancel Booking</button>
          <button type="button" class="btn btn-success" id="confirmBookingBtn" style="display:none;">Confirm Booking</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="userModalBody">
          <!-- Will be populated by JavaScript -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="blockUserBtn" style="display:none;">Block User</button>
          <button type="button" class="btn btn-success" id="unblockUserBtn" style="display:none;">Unblock User</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
      authDomain: "gopandacars-7085f.firebaseapp.com",
      projectId: "gopandacars-7085f",
      storageBucket: "gopandacars-7085f.appspot.com",
      messagingSenderId: "486383420605"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // DOM elements
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardSection = document.getElementById('dashboardSection');
    const bookingsSection = document.getElementById('bookingsSection');
    const usersSection = document.getElementById('usersSection');
    const offersSection = document.getElementById('offersSection');
    const carsSection = document.getElementById('carsSection');
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const addOfferModal = new bootstrap.Modal(document.getElementById('addOfferModal'));
    const addCarModal = new bootstrap.Modal(document.getElementById('addCarModal'));
    let currentBookingId = null;
    let currentUserId = null;

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        if (user.email === 'admin@gopandacars.com') {
          // Admin user
          loadDashboard();
          loadUsers();
          loadOffers();
          loadCars();
          setupEventListeners();
        } else {
          // Not admin
          window.location.href = 'profile.html';
        }
      } else {
        // No user signed in
        window.location.href = 'login.html';
      }
    });

    // Load dashboard data
    function loadDashboard() {
      // Load booking counts
      db.collection('bookings').get().then(snap => {
        document.getElementById('totalBookings').textContent = snap.size;
        
        const confirmed = snap.docs.filter(doc => doc.data().status === 'confirmed').length;
        const pending = snap.docs.filter(doc => doc.data().status === 'pending_payment').length;
        const cancelled = snap.docs.filter(doc => doc.data().status === 'cancelled').length;
        
        document.getElementById('confirmedBookings').textContent = confirmed;
        document.getElementById('pendingBookings').textContent = pending;
        document.getElementById('cancelledBookings').textContent = cancelled;
      });
      
      // Load recent bookings
      db.collection('bookings').orderBy('createdAt', 'desc').limit(5).get()
        .then(snap => {
          const tableBody = document.getElementById('recentBookingsTable');
          tableBody.innerHTML = '';
          
          snap.forEach(doc => {
            const booking = doc.data();
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${doc.id.substring(0, 6)}...</td>
              <td>${booking.carName}</td>
              <td>${booking.userEmail}</td>
              <td>${booking.startDate} to ${booking.endDate}</td>
              <td><span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status}</span></td>
              <td>₹${booking.finalPrice || booking.originalPrice}</td>
            `;
            tableBody.appendChild(row);
          });
        });
    }

    // Load all bookings
    function loadAllBookings(filter = 'all') {
      let query = db.collection('bookings').orderBy('createdAt', 'desc');
      
      if (filter !== 'all') {
        query = query.where('status', '==', filter);
      }
      
      // Use onSnapshot for real-time updates
      query.onSnapshot(snap => {
        const bookingsList = document.getElementById('bookingsList');
        bookingsList.innerHTML = '';
        
        if (snap.empty) {
          bookingsList.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-5"><h6 class="text-muted">No bookings found</h6></td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const booking = doc.data();
          addBookingRow(booking, doc.id);
        });
      }, error => {
        console.error("Error getting bookings: ", error);
      });
    }

    function addBookingRow(booking, bookingId) {
      const row = document.createElement('tr');
      row.className = 'booking-card';
      
      row.innerHTML = `
        <td>${bookingId.substring(0, 8)}</td>
        <td>${booking.carName}</td>
        <td>${booking.userEmail}</td>
        <td>${booking.startDate} to ${booking.endDate}</td>
        <td><span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status}</span></td>
        <td>₹${booking.finalPrice || booking.originalPrice}</td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-booking" data-booking-id="${bookingId}">
            <i class="fas fa-eye me-1"></i> View
          </button>
          ${booking.status === 'pending_payment' ? `
            <button class="btn btn-sm btn-success confirm-booking ms-1" data-booking-id="${bookingId}">
              <i class="fas fa-check me-1"></i> Confirm
            </button>
          ` : ''}
        </td>
      `;
      
      document.getElementById('bookingsList').appendChild(row);
    }

    // Load all users
    function loadUsers(filter = 'all') {
      let query = db.collection('users').orderBy('createdAt', 'desc');
      
      if (filter === 'active') {
        query = query.where('isBlocked', '==', false);
      } else if (filter === 'blocked') {
        query = query.where('isBlocked', '==', true);
      }
      
      query.onSnapshot(snap => {
        const usersList = document.getElementById('usersList');
        usersList.innerHTML = '';
        
        if (snap.empty) {
          usersList.innerHTML = `
            <tr>
              <td colspan="5" class="text-center py-5"><h6 class="text-muted">No users found</h6></td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const user = doc.data();
          addUserRow(user, doc.id);
        });
      }, error => {
        console.error("Error getting users: ", error);
      });
    }

    function addUserRow(user, userId) {
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${userId.substring(0, 8)}</td>
        <td>${user.email}</td>
        <td>${user.createdAt?.toDate().toLocaleDateString()}</td>
        <td>
          <span class="badge ${user.isBlocked ? 'bg-danger' : 'bg-success'}">
            ${user.isBlocked ? 'Blocked' : 'Active'}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary view-user" data-user-id="${userId}">
            <i class="fas fa-eye me-1"></i> View
          </button>
          ${!user.isBlocked ? `
            <button class="btn btn-sm btn-outline-danger block-user ms-1" data-user-id="${userId}">
              <i class="fas fa-ban me-1"></i> Block
            </button>
          ` : `
            <button class="btn btn-sm btn-outline-success unblock-user ms-1" data-user-id="${userId}">
              <i class="fas fa-check-circle me-1"></i> Unblock
            </button>
          `}
        </td>
      `;
      
      document.getElementById('usersList').appendChild(row);
    }

    // Load offers
    function loadOffers() {
      db.collection('offers').orderBy('createdAt', 'desc').onSnapshot(snap => {
        const offersList = document.getElementById('offersList');
        offersList.innerHTML = '';
        
        if (snap.empty) {
          offersList.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-5"><h6 class="text-muted">No offers found</h6></td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const offer = doc.data();
          addOfferRow(offer, doc.id);
        });
      }, error => {
        console.error("Error getting offers: ", error);
      });
    }

    function addOfferRow(offer, offerId) {
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>${offer.code}</td>
        <td>${offer.name}</td>
        <td>
          ${offer.discountType === 'percentage' ? 
            `${offer.discountValue}%` : 
            `₹${offer.discountValue}`}
        </td>
        <td>${new Date(offer.validUntil).toLocaleDateString()}</td>
        <td>
          <span class="badge ${offer.isActive ? 'bg-success' : 'bg-secondary'}">
            ${offer.isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary toggle-offer" 
                  data-offer-id="${offerId}" 
                  data-current-status="${offer.isActive}">
            ${offer.isActive ? 'Deactivate' : 'Activate'}
          </button>
          <button class="btn btn-sm btn-outline-danger delete-offer ms-1" 
                  data-offer-id="${offerId}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

          document.getElementById('offersList').appendChild(row);
    }

    // Load cars
    function loadCars() {
      db.collection('cars').orderBy('createdAt', 'desc').onSnapshot(snap => {
        const carsGrid = document.getElementById('carsGrid');
        carsGrid.innerHTML = '';
        
        if (snap.empty) {
          carsGrid.innerHTML = `
            <div class="col-12 text-center py-5">
              <h6 class="text-muted">No cars found</h6>
            </div>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const car = doc.data();
          addCarCard(car, doc.id);
        });
      }, error => {
        console.error("Error getting cars: ", error);
      });
    }

    function addCarCard(car, carId) {
      const col = document.createElement('div');
      col.className = 'col-md-4 mb-4';
      
      col.innerHTML = `
        <div class="card h-100">
          <img src="${car.imageUrl}" class="card-img-top" alt="${car.name}" style="height: 200px; object-fit: cover;">
          <div class="card-body">
            <h5 class="card-title">${car.name}</h5>
            <p class="card-text text-muted">${car.category.toUpperCase()}</p>
            <p class="card-text">${car.description.substring(0, 100)}...</p>
            <div class="d-flex justify-content-between">
              <div>
                <span class="badge bg-light text-dark me-2">12h: ₹${car.price12hrs}</span>
                <span class="badge bg-light text-dark">24h: ₹${car.price24hrs}</span>
              </div>
              <div>
                ${car.sunroof ? '<span class="badge bg-info me-1">Sunroof</span>' : ''}
                ${car.withDriver ? '<span class="badge bg-warning">With Driver</span>' : ''}
              </div>
            </div>
          </div>
          <div class="card-footer bg-white">
            <button class="btn btn-sm btn-outline-primary edit-car" data-car-id="${carId}">
              <i class="fas fa-edit me-1"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-danger delete-car ms-1" data-car-id="${carId}">
              <i class="fas fa-trash me-1"></i> Delete
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('carsGrid').appendChild(col);
    }

    // Helper function to get status badge class
    function getStatusBadgeClass(status) {
      switch(status) {
        case 'confirmed':
          return 'bg-success';
        case 'pending_payment':
          return 'bg-warning text-dark';
        case 'cancelled':
          return 'bg-danger';
        default:
          return 'bg-secondary';
      }
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Update active nav link
          document.querySelectorAll('.nav-link').forEach(navLink => {
            navLink.classList.remove('active');
          });
          this.classList.add('active');
          
          // Show corresponding section
          const target = this.getAttribute('data-bs-target');
          dashboardSection.style.display = 'none';
          bookingsSection.style.display = 'none';
          usersSection.style.display = 'none';
          offersSection.style.display = 'none';
          carsSection.style.display = 'none';
          
          switch(target) {
            case 'dashboard':
              dashboardSection.style.display = 'block';
              loadDashboard();
              break;
            case 'bookings':
              bookingsSection.style.display = 'block';
              loadAllBookings();
              break;
            case 'users':
              usersSection.style.display = 'block';
              loadUsers();
              break;
            case 'offers':
              offersSection.style.display = 'block';
              loadOffers();
              break;
            case 'cars':
              carsSection.style.display = 'block';
              loadCars();
              break;
          }
        });
      });

      // Logout
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      });

      // Booking filters
      document.querySelectorAll('.filter-booking').forEach(filter => {
        filter.addEventListener('click', (e) => {
          e.preventDefault();
          const status = filter.getAttribute('data-status');
          loadAllBookings(status);
        });
      });

      // User filters
      document.querySelectorAll('.filter-user').forEach(filter => {
        filter.addEventListener('click', (e) => {
          e.preventDefault();
          const status = filter.getAttribute('data-status');
          loadUsers(status);
        });
      });

      // View booking details
      document.addEventListener('click', (e) => {
        if (e.target.closest('.view-booking')) {
          const bookingId = e.target.closest('.view-booking').getAttribute('data-booking-id');
          viewBookingDetails(bookingId);
        }
        
        // Confirm booking
        if (e.target.closest('.confirm-booking')) {
          const bookingId = e.target.closest('.confirm-booking').getAttribute('data-booking-id');
          confirmBooking(bookingId);
        }
        
        // View user details
        if (e.target.closest('.view-user')) {
          const userId = e.target.closest('.view-user').getAttribute('data-user-id');
          viewUserDetails(userId);
        }
        
        // Block user
        if (e.target.closest('.block-user')) {
          const userId = e.target.closest('.block-user').getAttribute('data-user-id');
          blockUser(userId);
        }
        
        // Unblock user
        if (e.target.closest('.unblock-user')) {
          const userId = e.target.closest('.unblock-user').getAttribute('data-user-id');
          unblockUser(userId);
        }
        
        // Toggle offer status
        if (e.target.closest('.toggle-offer')) {
          const offerId = e.target.closest('.toggle-offer').getAttribute('data-offer-id');
          const currentStatus = e.target.closest('.toggle-offer').getAttribute('data-current-status') === 'true';
          toggleOfferStatus(offerId, !currentStatus);
        }
        
        // Delete offer
        if (e.target.closest('.delete-offer')) {
          const offerId = e.target.closest('.delete-offer').getAttribute('data-offer-id');
          deleteOffer(offerId);
        }
        
        // Edit car
        if (e.target.closest('.edit-car')) {
          const carId = e.target.closest('.edit-car').getAttribute('data-car-id');
          editCar(carId);
        }
        
        // Delete car
        if (e.target.closest('.delete-car')) {
          const carId = e.target.closest('.delete-car').getAttribute('data-car-id');
          deleteCar(carId);
        }
      });

      // Save new offer
      document.getElementById('saveOfferBtn').addEventListener('click', () => {
        saveNewOffer();
      });

      // Save new car
      document.getElementById('saveCarBtn').addEventListener('click', () => {
        saveNewCar();
      });

      // Confirm booking from modal
      document.getElementById('confirmBookingBtn').addEventListener('click', () => {
        if (currentBookingId) {
          confirmBooking(currentBookingId);
          bookingModal.hide();
        }
      });

      // Cancel booking from modal
      document.getElementById('cancelBookingBtn').addEventListener('click', () => {
        if (currentBookingId) {
          cancelBooking(currentBookingId);
          bookingModal.hide();
        }
      });

      // Block user from modal
      document.getElementById('blockUserBtn').addEventListener('click', () => {
        if (currentUserId) {
          blockUser(currentUserId);
          userModal.hide();
        }
      });

      // Unblock user from modal
      document.getElementById('unblockUserBtn').addEventListener('click', () => {
        if (currentUserId) {
          unblockUser(currentUserId);
          userModal.hide();
        }
      });
    }

    // View booking details
    async function viewBookingDetails(bookingId) {
      currentBookingId = bookingId;
      
      const doc = await db.collection('bookings').doc(bookingId).get();
      if (!doc.exists) {
        alert('Booking not found');
        return;
      }
      
      const booking = doc.data();
      const modalBody = document.getElementById('bookingModalBody');
      
      modalBody.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted">Booking Information</h6>
            <p><strong>Booking ID:</strong> ${bookingId}</p>
            <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status}</span></p>
            <p><strong>Created At:</strong> ${booking.createdAt?.toDate().toLocaleString()}</p>
            <p><strong>Dates:</strong> ${booking.startDate} to ${booking.endDate}</p>
            <p><strong>Pickup Location:</strong> ${booking.pickupLocation || 'Not specified'}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Car Information</h6>
            <p><strong>Car:</strong> ${booking.carName}</p>
            <p><strong>Category:</strong> ${booking.carCategory}</p>
            <p><strong>Original Price:</strong> ₹${booking.originalPrice}</p>
            ${booking.discountApplied ? `
              <p><strong>Discount Applied:</strong> ${booking.discountCode} (₹${booking.discountAmount || '0'})</p>
            ` : ''}
            <p><strong>Final Price:</strong> ₹${booking.finalPrice || booking.originalPrice}</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-md-6">
            <h6 class="text-muted">Customer Information</h6>
            <p><strong>Name:</strong> ${booking.userName || 'Not specified'}</p>
            <p><strong>Email:</strong> ${booking.userEmail}</p>
            <p><strong>Phone:</strong> ${booking.userPhone || 'Not specified'}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Payment Information</h6>
            <p><strong>Payment Method:</strong> ${booking.paymentMethod || 'Not specified'}</p>
            <p><strong>Payment Status:</strong> ${booking.paymentStatus || 'Pending'}</p>
            ${booking.transactionId ? `
              <p><strong>Transaction ID:</strong> ${booking.transactionId}</p>
            ` : ''}
          </div>
        </div>
      `;
      
      // Show appropriate action buttons
      document.getElementById('cancelBookingBtn').style.display = 'none';
      document.getElementById('confirmBookingBtn').style.display = 'none';
      
      if (booking.status === 'pending_payment') {
        document.getElementById('confirmBookingBtn').style.display = 'inline-block';
        document.getElementById('cancelBookingBtn').style.display = 'inline-block';
      }
      
      bookingModal.show();
    }

    // View user details
    async function viewUserDetails(userId) {
      currentUserId = userId;
      
      const doc = await db.collection('users').doc(userId).get();
      if (!doc.exists) {
        alert('User not found');
        return;
      }
      
      const user = doc.data();
      const modalBody = document.getElementById('userModalBody');
      
      modalBody.innerHTML = `
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted">Basic Information</h6>
            <p><strong>User ID:</strong> ${userId}</p>
            <p><strong>Email:</strong> ${user.email}</p>
            <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
            <p><strong>Status:</strong> <span class="badge ${user.isBlocked ? 'bg-danger' : 'bg-success'}">${user.isBlocked ? 'Blocked' : 'Active'}</span></p>
            <p><strong>Joined:</strong> ${user.createdAt?.toDate().toLocaleDateString()}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted">Additional Information</h6>
            <p><strong>Name:</strong> ${user.name || 'Not provided'}</p>
            <p><strong>Address:</strong> ${user.address || 'Not provided'}</p>
            <p><strong>License Number:</strong> ${user.driverLicense || 'Not provided'}</p>
          </div>
        </div>
        <div class="row mt-3">
          <div class="col-12">
            <h6 class="text-muted">Booking History</h6>
            <p>Total bookings: ${user.totalBookings || 0}</p>
            <!-- Could add more detailed booking history here -->
          </div>
        </div>
      `;
      
      // Show appropriate action buttons
      document.getElementById('blockUserBtn').style.display = 'none';
      document.getElementById('unblockUserBtn').style.display = 'none';
      
      if (user.isBlocked) {
        document.getElementById('unblockUserBtn').style.display = 'inline-block';
      } else {
        document.getElementById('blockUserBtn').style.display = 'inline-block';
      }
      
      userModal.show();
    }

    // Confirm booking
    function confirmBooking(bookingId) {
      if (!confirm('Are you sure you want to confirm this booking?')) return;
      
      db.collection('bookings').doc(bookingId).update({
        status: 'confirmed',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Booking confirmed successfully');
      })
      .catch(error => {
        console.error("Error confirming booking: ", error);
        alert('Failed to confirm booking');
      });
    }

    // Cancel booking
    function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;
      
      db.collection('bookings').doc(bookingId).update({
        status: 'cancelled',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Booking cancelled successfully');
      })
      .catch(error => {
        console.error("Error cancelling booking: ", error);
        alert('Failed to cancel booking');
      });
    }

    // Block user
    function blockUser(userId) {
      if (!confirm('Are you sure you want to block this user?')) return;
      
      db.collection('users').doc(userId).update({
        isBlocked: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User blocked successfully');
      })
      .catch(error => {
        console.error("Error blocking user: ", error);
        alert('Failed to block user');
      });
    }

    // Unblock user
    function unblockUser(userId) {
      if (!confirm('Are you sure you want to unblock this user?')) return;
      
      db.collection('users').doc(userId).update({
        isBlocked: false,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User unblocked successfully');
      })
      .catch(error => {
        console.error("Error unblocking user: ", error);
        alert('Failed to unblock user');
      });
    }

    // Toggle offer status
    function toggleOfferStatus(offerId, newStatus) {
      db.collection('offers').doc(offerId).update({
        isActive: newStatus,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        // Status updated automatically via onSnapshot
      })
      .catch(error => {
        console.error("Error toggling offer status: ", error);
        alert('Failed to update offer status');
      });
    }

    // Delete offer
    function deleteOffer(offerId) {
      if (!confirm('Are you sure you want to delete this offer?')) return;
      
      db.collection('offers').doc(offerId).delete()
      .then(() => {
        // Offer removed automatically via onSnapshot
      })
      .catch(error => {
        console.error("Error deleting offer: ", error);
        alert('Failed to delete offer');
      });
    }

    // Save new offer
    function saveNewOffer() {
      const offerCode = document.getElementById('offerCode').value;
      const offerName = document.getElementById('offerName').value;
      const offerDescription = document.getElementById('offerDescription').value;
      const discountType = document.getElementById('discountType').value;
      const discountValue = parseFloat(document.getElementById('discountValue').value);
      const validUntil = document.getElementById('validUntil').value;
      const isActive = document.getElementById('isActive').checked;
      
      if (!offerCode || !offerName || !discountValue || !validUntil) {
        alert('Please fill all required fields');
        return;
      }
      
      const newOffer = {
        code: offerCode,
        name: offerName,
        description: offerDescription,
        discountType,
        discountValue,
        validUntil: new Date(validUntil),
        isActive,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection('offers').add(newOffer)
        .then(() => {
          alert('Offer created successfully');
          addOfferModal.hide();
          document.getElementById('offerForm').reset();
        })
        .catch(error => {
          console.error("Error adding offer: ", error);
          alert('Failed to create offer');
        });
    }

    // Save new car
    function saveNewCar() {
      const carName = document.getElementById('carName').value;
      const carImage = document.getElementById('carImage').value;
      const carDescription = document.getElementById('carDescription').value;
      const carCategory = document.getElementById('carCategory').value;
      const carPrice12hrs = parseFloat(document.getElementById('carPrice12hrs').value);
      const carPrice24hrs = parseFloat(document.getElementById('carPrice24hrs').value);
      const carSunroof = document.getElementById('carSunroof').checked;
      const carWithDriver = document.getElementById('carWithDriver').checked;
      
      if (!carName || !carImage || !carDescription || !carPrice12hrs || !carPrice24hrs) {
        alert('Please fill all required fields');
        return;
      }
      
      const newCar = {
        name: carName,
        imageUrl: carImage,
        description: carDescription,
        category: carCategory,
        price12hrs: carPrice12hrs,
        price24hrs: carPrice24hrs,
        sunroof: carSunroof,
        withDriver: carWithDriver,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection('cars').add(newCar)
        .then(() => {
          alert('Car added successfully');
          addCarModal.hide();
          document.getElementById('carForm').reset();
        })
        .catch(error => {
          console.error("Error adding car: ", error);
          alert('Failed to add car');
        });
    }

    // Edit car (placeholder - would need a separate edit modal)
    function editCar(carId) {
      alert('Edit car functionality would be implemented here');
      // Would need to fetch car details and populate an edit modal
    }

    // Delete car
    function deleteCar(carId) {
      if (!confirm('Are you sure you want to delete this car? This cannot be undone.')) return;
      
      db.collection('cars').doc(carId).delete()
        .then(() => {
          // Car removed automatically via onSnapshot
        })
        .catch(error => {
          console.error("Error deleting car: ", error);
          alert('Failed to delete car');
        });
    }
  </script>
</body>
</html>
      
     
