<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard | GoPandaCars</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    .sidebar { 
      min-height: 100vh; 
      background-color: #f8f9fa; 
      position: sticky;
      top: 0;
    }
    .nav-link { color: #333; }
    .nav-link.active { 
      color: #0d6efd; 
      font-weight: 500;
      background-color: rgba(13, 110, 253, 0.1);
      border-radius: 5px;
    }
    .badge-status { font-size: 0.8rem; }
    .booking-card { transition: all 0.3s; }
    .booking-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .card-img-top { 
      height: 200px; 
      object-fit: cover;
      border-radius: 5px 5px 0 0;
    }
    .loading-spinner {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 200px;
    }
    .notification-item {
      padding: 12px 15px;
      border-bottom: 1px solid #eee;
      transition: background-color 0.2s;
    }
    .notification-item:hover {
      background-color: #f8f9fa;
    }
    .notification-item.unread {
      background-color: #f0f7ff;
    }
    .notification-time {
      font-size: 0.75rem;
      color: #6c757d;
    }
    .car-feature-badge {
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .dashboard-card {
      transition: transform 0.3s;
    }
    .dashboard-card:hover {
      transform: translateY(-5px);
    }
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
    .status-badge {
      font-size: 0.8rem;
      padding: 5px 8px;
      border-radius: 4px;
    }
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .action-buttons .btn {
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .search-box {
      position: relative;
      margin-bottom: 20px;
    }
    .search-box i {
      position: absolute;
      left: 10px;
      top: 10px;
      color: #6c757d;
    }
    .search-box input {
      padding-left: 35px;
    }
    .pagination {
      justify-content: center;
      margin-top: 20px;
    }
  </style>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container-fluid">
    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3 col-lg-2 d-md-block sidebar p-0">
        <div class="position-sticky pt-3 h-100">
          <div class="text-center mb-4 p-3 bg-white shadow-sm">
            <h4 class="mb-0">GoPandaCars</h4>
            <p class="text-muted small mb-0">Admin Dashboard</p>
          </div>
          <ul class="nav flex-column px-3">
            <li class="nav-item mb-2">
              <a class="nav-link active" href="#" data-target="dashboard">
                <i class="fas fa-tachometer-alt me-2"></i>Dashboard
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="bookings">
                <i class="fas fa-calendar-check me-2"></i>Bookings
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="users">
                <i class="fas fa-users me-2"></i>Users
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="offers">
                <i class="fas fa-tag me-2"></i>Offers
              </a>
            </li>
            <li class="nav-item mb-2">
              <a class="nav-link" href="#" data-target="cars">
                <i class="fas fa-car me-2"></i>Cars
              </a>
            </li>
            <li class="nav-item mt-4 mb-2">
              <a class="nav-link text-danger" href="#" id="logoutBtn">
                <i class="fas fa-sign-out-alt me-2"></i>Logout
              </a>
            </li>
          </ul>
        </div>
      </div>

      <!-- Main Content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 py-4">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <div class="d-flex align-items-center">
            <h1 class="h2 me-3">Admin Dashboard</h1>
            <div class="position-relative">
              <button class="btn btn-outline-secondary position-relative" id="notificationsBtn">
                <i class="fas fa-bell"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                  0
                </span>
              </button>
              <div class="dropdown-menu dropdown-menu-end p-0 shadow" id="notificationsDropdown" style="width: 350px; max-height: 400px; overflow-y: auto; display: none;">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom bg-light">
                  <h6 class="mb-0 fw-bold">Notifications</h6>
                  <button class="btn btn-sm btn-outline-secondary" id="clearNotificationsBtn">Clear All</button>
                </div>
                <div id="notificationsList">
                  <div class="p-3 text-center text-muted">No new notifications</div>
                </div>
              </div>
            </div>
          </div>
          <div class="text-muted">
            <i class="fas fa-calendar-alt me-1"></i>
            <span id="currentDate"></span>
          </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection">
          <div class="row mb-4">
            <div class="col-md-3">
              <div class="card text-white bg-primary mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Total Bookings</h5>
                      <h2 class="card-text" id="totalBookings">0</h2>
                    </div>
                    <i class="fas fa-calendar fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">This month: <span id="monthlyBookings">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-success mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Confirmed</h5>
                      <h2 class="card-text" id="confirmedBookings">0</h2>
                    </div>
                    <i class="fas fa-check-circle fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">This month: <span id="monthlyConfirmed">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-warning mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Pending</h5>
                      <h2 class="card-text" id="pendingBookings">0</h2>
                    </div>
                    <i class="fas fa-clock fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">Needs action: <span id="pendingAction">0</span></p>
                </div>
              </div>
            </div>
            <div class="col-md-3">
              <div class="card text-white bg-danger mb-3 dashboard-card">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-center">
                    <div>
                      <h5 class="card-title">Cancelled</h5>
                      <h2 class="card-text" id="cancelledBookings">0</h2>
                    </div>
                    <i class="fas fa-times-circle fa-2x opacity-50"></i>
                  </div>
                  <p class="card-text small mb-0">This month: <span id="monthlyCancelled">0</span></p>
                </div>
              </div>
            </div>
          </div>

          <div class="row mb-4">
            <div class="col-md-8">
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Bookings Overview</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="bookingsChart"></canvas>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                  <h5 class="mb-0">Revenue</h5>
                </div>
                <div class="card-body">
                  <div class="chart-container">
                    <canvas id="revenueChart"></canvas>
                  </div>
                  <div class="text-center mt-3">
                    <h4>â‚¹<span id="totalRevenue">0</span></h4>
                    <p class="text-muted small mb-0">Total revenue this month</p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-12">
              <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Recent Bookings</h5>
                  <a href="#" class="btn btn-sm btn-outline-primary" id="viewAllBookings">View All</a>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-hover mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Booking ID</th>
                          <th>Car</th>
                          <th>Customer</th>
                          <th>Dates</th>
                          <th>Status</th>
                          <th>Amount</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody id="recentBookingsTable">
                        <tr>
                          <td colspan="7" class="text-center loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                              <span class="visually-hidden">Loading...</span>
                            </div>
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Bookings Section -->
        <div id="bookingsSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Bookings</h4>
            <div class="d-flex">
              <div class="search-box me-3">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="bookingSearch" placeholder="Search bookings...">
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Filter
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item filter-booking active" data-status="all" href="#">All Bookings</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item filter-booking" data-status="pending_payment" href="#">Pending Payment</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="awaiting_verification" href="#">Awaiting Verification</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="confirmed" href="#">Confirmed</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="active" href="#">Active</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="completed" href="#">Completed</a></li>
                  <li><a class="dropdown-item filter-booking" data-status="cancelled" href="#">Cancelled</a></li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Booking ID</th>
                      <th>Car</th>
                      <th>Customer</th>
                      <th>Dates</th>
                      <th>Status</th>
                      <th>Amount</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="bookingsList">
                    <tr>
                      <td colspan="7" class="text-center loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <nav aria-label="Bookings pagination" class="p-3">
                <ul class="pagination mb-0" id="bookingsPagination">
                  <!-- Pagination will be added here dynamically -->
                </ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- Users Section -->
        <div id="usersSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Users</h4>
            <div class="d-flex">
              <div class="search-box me-3">
                <i class="fas fa-search"></i>
                <input type="text" class="form-control" id="userSearch" placeholder="Search users...">
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                  Filter
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item filter-user active" data-status="all" href="#">All Users</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item filter-user" data-status="active" href="#">Active</a></li>
                  <li><a class="dropdown-item filter-user" data-status="blocked" href="#">Blocked</a></li>
                  <li><a class="dropdown-item filter-user" data-status="with_bookings" href="#">With Bookings</a></li>
                </ul>
              </div>
            </div>
          </div>
          
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>User</th>
                      <th>Email</th>
                      <th>Joined</th>
                      <th>Bookings</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="usersList">
                    <tr>
                      <td colspan="6" class="text-center loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <nav aria-label="Users pagination" class="p-3">
                <ul class="pagination mb-0" id="usersPagination">
                  <!-- Pagination will be added here dynamically -->
                </ul>
              </nav>
            </div>
          </div>
        </div>

        <!-- Offers Section -->
        <div id="offersSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Offers</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addOfferModal">
              <i class="fas fa-plus me-1"></i> Add New Offer
            </button>
          </div>
          
          <div class="card shadow-sm">
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-hover mb-0">
                  <thead class="table-light">
                    <tr>
                      <th>Code</th>
                      <th>Name</th>
                      <th>Discount</th>
                      <th>Valid Until</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="offersList">
                    <tr>
                      <td colspan="6" class="text-center loading-spinner">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Cars Section -->
        <div id="carsSection" style="display: none;">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">Manage Cars</h4>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCarModal">
              <i class="fas fa-plus me-1"></i> Add New Car
            </button>
          </div>
          
          <div class="row" id="carsGrid">
            <div class="col-12 text-center loading-spinner">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Add Offer Modal -->
  <div class="modal fade" id="addOfferModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Create New Offer</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="offerForm">
            <div class="mb-3">
              <label class="form-label">Offer Code*</label>
              <input type="text" class="form-control" id="offerCode" required>
              <small class="text-muted">Unique code customers will enter (e.g., SUMMER20)</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Offer Name*</label>
              <input type="text" class="form-control" id="offerName" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Description</label>
              <textarea class="form-control" id="offerDescription" rows="3"></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Type*</label>
                <select class="form-select" id="discountType" required>
                  <option value="percentage">Percentage</option>
                  <option value="fixed">Fixed Amount</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Discount Value*</label>
                <input type="number" class="form-control" id="discountValue" required>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Valid Until*</label>
              <input type="date" class="form-control" id="validUntil" required>
            </div>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" id="isActive" checked>
              <label class="form-check-label" for="isActive">Active</label>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveOfferBtn" class="btn btn-primary">
            <span class="submit-text">Save Offer</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Car Modal -->
  <div class="modal fade" id="addCarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add New Car</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="carForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Car Name*</label>
                <input type="text" class="form-control" id="carName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Category*</label>
                <select class="form-select" id="carCategory" required>
                  <option value="economy">Economy</option>
                  <option value="premium">Premium</option>
                  <option value="luxury">Luxury</option>
                </select>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Image URL*</label>
              <input type="url" class="form-control" id="carImage" required>
              <small class="text-muted">Paste a direct image URL (e.g., from Imgur)</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Description*</label>
              <textarea class="form-control" id="carDescription" rows="3" required></textarea>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">12 Hours Price (â‚¹)*</label>
                <input type="number" class="form-control" id="carPrice12hrs" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">24 Hours Price (â‚¹)*</label>
                <input type="number" class="form-control" id="carPrice24hrs" required>
              </div>
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Features</label>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="carSunroof">
                  <label class="form-check-label" for="carSunroof">Sunroof</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="carWithDriver">
                  <label class="form-check-label" for="carWithDriver">With Driver</label>
                </div>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Transmission</label>
                <select class="form-select" id="carTransmission">
                  <option value="automatic">Automatic</option>
                  <option value="manual">Manual</option>
                </select>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="saveCarBtn" class="btn btn-primary">
            <span class="submit-text">Save Car</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Booking Details Modal -->
  <div class="modal fade" id="bookingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Booking Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="bookingModalBody">
          Loading booking details...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="cancelBookingBtn" style="display:none;">Cancel Booking</button>
          <button type="button" class="btn btn-success" id="confirmBookingBtn" style="display:none;">Confirm Booking</button>
          <button type="button" class="btn btn-primary" id="verifyPaymentBtn" style="display:none;">Verify Payment</button>
        </div>
      </div>
    </div>
  </div>

  <!-- User Details Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Details</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="userModalBody">
          Loading user details...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-danger" id="blockUserBtn" style="display:none;">Block User</button>
          <button type="button" class="btn btn-success" id="unblockUserBtn" style="display:none;">Unblock User</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Verify Payment Modal -->
  <div class="modal fade" id="verifyPaymentModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Verify Payment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="verifyPaymentForm">
            <div class="mb-3">
              <label class="form-label">Payment Verified?</label>
              <select class="form-select" id="verificationStatus" required>
                <option value="verified">Yes, Payment Verified</option>
                <option value="rejected">No, Reject Payment</option>
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">Admin Notes</label>
              <textarea class="form-control" id="verificationNotes" rows="3"></textarea>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="submitVerificationBtn" class="btn btn-primary">
            <span class="submit-text">Submit Verification</span>
            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Sound -->
  <audio id="notificationSound" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3" type="audio/mpeg">
  </audio>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAJKgz1fONteZPPD5T9bcIVjw3-iBUZyro",
      authDomain: "gopandacars-7085f.firebaseapp.com",
      projectId: "gopandacars-7085f",
      storageBucket: "gopandacars-7085f.appspot.com",
      messagingSenderId: "486383420605"
    };

    // Initialize Firebase
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // DOM elements
    const logoutBtn = document.getElementById('logoutBtn');
    const dashboardSection = document.getElementById('dashboardSection');
    const bookingsSection = document.getElementById('bookingsSection');
    const usersSection = document.getElementById('usersSection');
    const offersSection = document.getElementById('offersSection');
    const carsSection = document.getElementById('carsSection');
    const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
    const userModal = new bootstrap.Modal(document.getElementById('userModal'));
    const addOfferModal = new bootstrap.Modal(document.getElementById('addOfferModal'));
    const addCarModal = new bootstrap.Modal(document.getElementById('addCarModal'));
    const verifyPaymentModal = new bootstrap.Modal(document.getElementById('verifyPaymentModal'));
    const notificationSound = document.getElementById('notificationSound');
    const notificationBadge = document.getElementById('notificationBadge');
    const notificationsList = document.getElementById('notificationsList');
    const notificationsDropdown = document.getElementById('notificationsDropdown');
    const notificationsBtn = document.getElementById('notificationsBtn');
    const clearNotificationsBtn = document.getElementById('clearNotificationsBtn');
    const viewAllBookings = document.getElementById('viewAllBookings');
    const currentDateElement = document.getElementById('currentDate');
    
    // Global variables
    let currentBookingId = null;
    let currentUserId = null;
    let lastBookingTimestamp = null;
    let unreadNotifications = 0;
    let bookingsChart = null;
    let revenueChart = null;
    
    // Current date display
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    currentDateElement.textContent = new Date().toLocaleDateString('en-US', options);

    // Check auth state
    auth.onAuthStateChanged(user => {
      if (user) {
        // Check if user is admin (you might want to implement proper admin check)
        if (user.email === 'admin@gopandacars.in') {
          // Admin user
          loadDashboard();
          setupEventListeners();
          setupNotifications();
        } else {
          // Not admin
          window.location.href = 'profile.html';
        }
      } else {
        // No user signed in
        window.location.href = 'login.html';
      }
    });

    // Setup notifications system
    function setupNotifications() {
      // Load last booking timestamp from localStorage
      const lastTimestamp = localStorage.getItem('lastBookingTimestamp');
      if (lastTimestamp) {
        lastBookingTimestamp = new Date(parseInt(lastTimestamp));
      }
      
      // Set up real-time listener for new bookings
      db.collection('bookings').orderBy('createdAt', 'desc').limit(1)
        .onSnapshot(snapshot => {
          snapshot.docChanges().forEach(change => {
            if (change.type === 'added') {
              const booking = change.doc.data();
              const bookingTime = booking.createdAt.toDate();
              
              // Check if this is a new booking since last check
              if (!lastBookingTimestamp || bookingTime > lastBookingTimestamp) {
                lastBookingTimestamp = bookingTime;
                localStorage.setItem('lastBookingTimestamp', bookingTime.getTime().toString());
                
                // Only show notification if not initial load
                if (lastBookingTimestamp) {
                  addNewBookingNotification(change.doc.id, booking);
                  playNotificationSound();
                }
              }
            }
          });
        });
        
      // Load existing notifications
      loadNotifications();
      
      // Notification button click handler
      notificationsBtn.addEventListener('click', () => {
        notificationsDropdown.style.display = notificationsDropdown.style.display === 'block' ? 'none' : 'block';
        markNotificationsAsRead();
      });
      
      // Clear notifications button
      clearNotificationsBtn.addEventListener('click', clearNotifications);
      
      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!notificationsBtn.contains(e.target) && !notificationsDropdown.contains(e.target)) {
          notificationsDropdown.style.display = 'none';
        }
      });
    }

    function playNotificationSound() {
      notificationSound.currentTime = 0; // Rewind to start
      notificationSound.play().catch(e => console.log("Audio play failed:", e));
    }

    function addNewBookingNotification(bookingId, booking) {
      unreadNotifications++;
      updateNotificationBadge();
      
      const notificationItem = document.createElement('div');
      notificationItem.className = 'notification-item unread';
      notificationItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong>New Booking</strong>
            <p class="mb-1">${booking.carName || 'Unknown car'} booked by ${booking.userEmail || 'unknown user'}</p>
            <p class="mb-0 notification-time">${new Date().toLocaleTimeString()}</p>
          </div>
          <a href="#" class="btn btn-sm btn-outline-primary view-notification" data-booking-id="${bookingId}">View</a>
        </div>
      `;
      
      // Add to top of list
      if (notificationsList.firstChild) {
        notificationsList.insertBefore(notificationItem, notificationsList.firstChild);
      } else {
        notificationsList.appendChild(notificationItem);
      }
      
      // Add click handler for view button
      notificationItem.querySelector('.view-notification').addEventListener('click', (e) => {
        e.preventDefault();
        viewBookingDetails(bookingId);
        notificationsDropdown.style.display = 'none';
      });
    }

    function updateNotificationBadge() {
      if (unreadNotifications > 0) {
        notificationBadge.style.display = 'block';
        notificationBadge.textContent = unreadNotifications;
      } else {
        notificationBadge.style.display = 'none';
      }
    }

    function markNotificationsAsRead() {
      unreadNotifications = 0;
      updateNotificationBadge();
      
      // Remove unread styling
      document.querySelectorAll('.notification-item.unread').forEach(item => {
        item.classList.remove('unread');
      });
    }

    function clearNotifications() {
      notificationsList.innerHTML = '<div class="p-3 text-center text-muted">No notifications</div>';
      markNotificationsAsRead();
    }

    function loadNotifications() {
      // In a real app, you might load persisted notifications from a database
      notificationsList.innerHTML = '<div class="p-3 text-center text-muted">No notifications</div>';
    }

    // Load dashboard data
    function loadDashboard() {
      // Load booking counts
      db.collection('bookings').get().then(snap => {
        document.getElementById('totalBookings').textContent = snap.size;
        
        const confirmed = snap.docs.filter(doc => doc.data().status === 'confirmed').length;
        const pending = snap.docs.filter(doc => doc.data().status === 'pending_payment').length;
        const cancelled = snap.docs.filter(doc => doc.data().status === 'cancelled').length;
        const awaiting = snap.docs.filter(doc => doc.data().status === 'awaiting_verification').length;
        
        document.getElementById('confirmedBookings').textContent = confirmed;
        document.getElementById('pendingBookings').textContent = pending + awaiting;
        document.getElementById('pendingAction').textContent = awaiting;
        document.getElementById('cancelledBookings').textContent = cancelled;
        
        // Monthly stats
        const now = new Date();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const monthlyQuery = db.collection('bookings')
          .where('createdAt', '>=', startOfMonth);
          
        monthlyQuery.get().then(monthlySnap => {
          const monthlyTotal = monthlySnap.size;
          const monthlyConfirmed = monthlySnap.docs.filter(doc => doc.data().status === 'confirmed').length;
          const monthlyCancelled = monthlySnap.docs.filter(doc => doc.data().status === 'cancelled').length;
          
          document.getElementById('monthlyBookings').textContent = monthlyTotal;
          document.getElementById('monthlyConfirmed').textContent = monthlyConfirmed;
          document.getElementById('monthlyCancelled').textContent = monthlyCancelled;
          
          // Calculate monthly revenue
          let monthlyRevenue = 0;
          monthlySnap.forEach(doc => {
            const booking = doc.data();
            if (booking.status === 'confirmed' || booking.status === 'completed') {
              monthlyRevenue += booking.finalPrice || 0;
            }
          });
          document.getElementById('totalRevenue').textContent = monthlyRevenue.toLocaleString();
        });
      }).catch(error => {
        console.error("Error loading booking counts:", error);
      });
      
      // Load recent bookings
      db.collection('bookings').orderBy('createdAt', 'desc').limit(5).get()
        .then(snap => {
          const tableBody = document.getElementById('recentBookingsTable');
          tableBody.innerHTML = '';
          
          if (snap.empty) {
            tableBody.innerHTML = `
              <tr>
                <td colspan="7" class="text-center py-5"><h6 class="text-muted">No recent bookings found</h6></td>
              </tr>
            `;
            return;
          }
          
          snap.forEach(doc => {
            const booking = doc.data();
            const row = document.createElement('tr');
            row.className = 'booking-card';
            row.innerHTML = `
              <td>${doc.id.substring(0, 8)}</td>
              <td>${booking.carName || 'N/A'}</td>
              <td>${booking.userEmail || 'N/A'}</td>
              <td>${formatDate(booking.startDateTime)} - ${formatDate(booking.endDateTime)}</td>
              <td><span class="status-badge ${getStatusBadgeClass(booking.status)}">${booking.status.replace('_', ' ')}</span></td>
              <td>â‚¹${booking.finalPrice || booking.originalPrice || '0'}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary view-booking" data-booking-id="${doc.id}">
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });
        }).catch(error => {
          console.error("Error loading recent bookings:", error);
          document.getElementById('recentBookingsTable').innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-5 text-danger">Error loading bookings</td>
            </tr>
          `;
        });
        
      // Initialize charts
      initCharts();
    }

    // Initialize dashboard charts
    function initCharts() {
      // Bookings chart
      const bookingsCtx = document.getElementById('bookingsChart').getContext('2d');
      
      // Get data for last 7 days
      const dates = [];
      const bookingCounts = [];
      const now = new Date();
      
      for (let i = 6; i >= 0; i--) {
        const date = new Date(now);
        date.setDate(date.getDate() - i);
        dates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
        bookingCounts.push(0); // Initialize with 0
      }
      
      // Query bookings from last 7 days
      const sevenDaysAgo = new Date(now);
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 6);
      sevenDaysAgo.setHours(0, 0, 0, 0);
      
      db.collection('bookings')
        .where('createdAt', '>=', sevenDaysAgo)
        .get()
        .then(snap => {
          snap.forEach(doc => {
            const bookingDate = doc.data().createdAt.toDate();
            const dayIndex = 6 - Math.floor((now - bookingDate) / (1000 * 60 * 60 * 24));
            
            if (dayIndex >= 0 && dayIndex < 7) {
              bookingCounts[dayIndex]++;
            }
          });
          
          // Create chart
          bookingsChart = new Chart(bookingsCtx, {
            type: 'line',
            data: {
              labels: dates,
              datasets: [{
                label: 'Bookings',
                data: bookingCounts,
                backgroundColor: 'rgba(13, 110, 253, 0.1)',
                borderColor: '#0d6efd',
                borderWidth: 2,
                tension: 0.3,
                fill: true
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  display: false
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    stepSize: 1
                  }
                }
              }
            }
          });
        });
      
      // Revenue chart
      const revenueCtx = document.getElementById('revenueChart').getContext('2d');
      
      revenueChart = new Chart(revenueCtx, {
        type: 'doughnut',
        data: {
          labels: ['Economy', 'Premium', 'Luxury'],
          datasets: [{
            data: [0, 0, 0], // Will be updated
            backgroundColor: [
              '#28a745',
              '#007bff',
              '#dc3545'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          cutout: '70%',
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
      
      // Get revenue data by category
      db.collection('bookings')
        .where('status', 'in', ['confirmed', 'completed'])
        .get()
        .then(snap => {
          const revenueByCategory = {
            economy: 0,
            premium: 0,
            luxury: 0
          };
          
          snap.forEach(doc => {
            const booking = doc.data();
            const category = booking.carCategory || 'economy';
            revenueByCategory[category] += booking.finalPrice || 0;
          });
          
          // Update chart data
          revenueChart.data.datasets[0].data = [
            revenueByCategory.economy,
            revenueByCategory.premium,
            revenueByCategory.luxury
          ];
          revenueChart.update();
        });
    }

    // Load all bookings with pagination
    let currentBookingsPage = 1;
    const bookingsPerPage = 10;
    let currentBookingsFilter = 'all';
    let currentBookingsSearch = '';
    
    function loadAllBookings(page = 1, filter = 'all', search = '') {
      currentBookingsPage = page;
      currentBookingsFilter = filter;
      currentBookingsSearch = search.toLowerCase();
      
      let query = db.collection('bookings').orderBy('createdAt', 'desc');
      
      if (filter !== 'all') {
        query = query.where('status', '==', filter);
      }
      
      query.get().then(snap => {
        const allBookings = [];
        snap.forEach(doc => {
          const booking = doc.data();
          booking.id = doc.id;
          
          // Apply search filter if any
          if (search === '' || 
              booking.carName.toLowerCase().includes(search) || 
              booking.userEmail.toLowerCase().includes(search) || 
              booking.id.toLowerCase().includes(search)) {
            allBookings.push(booking);
          }
        });
        
        const totalBookings = allBookings.length;
        const totalPages = Math.ceil(totalBookings / bookingsPerPage);
        const startIndex = (page - 1) * bookingsPerPage;
        const paginatedBookings = allBookings.slice(startIndex, startIndex + bookingsPerPage);
        
        renderBookingsTable(paginatedBookings);
        renderBookingsPagination(page, totalPages);
      }).catch(error => {
        console.error("Error loading bookings:", error);
        document.getElementById('bookingsList').innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-5 text-danger">Error loading bookings</td>
          </tr>
        `;
      });
    }

    function renderBookingsTable(bookings) {
      const bookingsList = document.getElementById('bookingsList');
      bookingsList.innerHTML = '';
      
      if (bookings.length === 0) {
        bookingsList.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-5"><h6 class="text-muted">No bookings found</h6></td>
          </tr>
        `;
        return;
      }
      
      bookings.forEach(booking => {
        addBookingRow(booking, booking.id);
      });
    }

    function renderBookingsPagination(currentPage, totalPages) {
      const pagination = document.getElementById('bookingsPagination');
      pagination.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
      pagination.appendChild(prevLi);
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
        pagination.appendChild(firstLi);
        
        if (startPage > 2) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(pageLi);
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
        pagination.appendChild(lastLi);
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
      pagination.appendChild(nextLi);
    }

    function addBookingRow(booking, bookingId) {
      const row = document.createElement('tr');
      row.className = 'booking-card';
      
      row.innerHTML = `
        <td>${bookingId.substring(0, 8)}</td>
        <td>${booking.carName || 'N/A'}</td>
        <td>${booking.userEmail || 'N/A'}</td>
        <td>${formatDate(booking.startDateTime)} - ${formatDate(booking.endDateTime)}</td>
        <td><span class="status-badge ${getStatusBadgeClass(booking.status)}">${booking.status.replace('_', ' ')}</span></td>
        <td>â‚¹${booking.finalPrice || booking.originalPrice || '0'}</td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-outline-primary view-booking" data-booking-id="${bookingId}">
            <i class="fas fa-eye"></i>
          </button>
          ${booking.status === 'pending_payment' ? `
            <button class="btn btn-sm btn-success confirm-booking" data-booking-id="${bookingId}">
              <i class="fas fa-check"></i>
            </button>
          ` : ''}
          ${booking.status === 'awaiting_verification' ? `
            <button class="btn btn-sm btn-info verify-payment" data-booking-id="${bookingId}">
              <i class="fas fa-check-circle"></i>
            </button>
          ` : ''}
          ${booking.status !== 'cancelled' && booking.status !== 'completed' ? `
            <button class="btn btn-sm btn-danger cancel-booking" data-booking-id="${bookingId}">
              <i class="fas fa-times"></i>
            </button>
          ` : ''}
        </td>
      `;
      
      document.getElementById('bookingsList').appendChild(row);
    }

    // Load all users with pagination
    let currentUsersPage = 1;
    const usersPerPage = 10;
    let currentUsersFilter = 'all';
    let currentUsersSearch = '';
    
    function loadUsers(page = 1, filter = 'all', search = '') {
      currentUsersPage = page;
      currentUsersFilter = filter;
      currentUsersSearch = search.toLowerCase();
      
      let query = db.collection('users').orderBy('createdAt', 'desc');
      
      if (filter === 'active') {
        query = query.where('isBlocked', '==', false);
      } else if (filter === 'blocked') {
        query = query.where('isBlocked', '==', true);
      } else if (filter === 'with_bookings') {
        // This would require a more complex query in a real app
      }
      
      query.get().then(snap => {
        const allUsers = [];
        snap.forEach(doc => {
          const user = doc.data();
          user.id = doc.id;
          
          // Apply search filter if any
          if (search === '' || 
              user.email.toLowerCase().includes(search) || 
              user.name?.toLowerCase().includes(search) || 
              user.phone?.includes(search)) {
            allUsers.push(user);
          }
        });
        
        const totalUsers = allUsers.length;
        const totalPages = Math.ceil(totalUsers / usersPerPage);
        const startIndex = (page - 1) * usersPerPage;
        const paginatedUsers = allUsers.slice(startIndex, startIndex + usersPerPage);
        
        renderUsersTable(paginatedUsers);
        renderUsersPagination(page, totalPages);
      }).catch(error => {
        console.error("Error loading users:", error);
        document.getElementById('usersList').innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-5 text-danger">Error loading users</td>
          </tr>
        `;
      });
    }

    function renderUsersTable(users) {
      const usersList = document.getElementById('usersList');
      usersList.innerHTML = '';
      
      if (users.length === 0) {
        usersList.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-5"><h6 class="text-muted">No users found</h6></td>
          </tr>
        `;
        return;
      }
      
      users.forEach(user => {
        addUserRow(user, user.id);
      });
    }

    function renderUsersPagination(currentPage, totalPages) {
      const pagination = document.getElementById('usersPagination');
      pagination.innerHTML = '';
      
      if (totalPages <= 1) return;
      
      // Previous button
      const prevLi = document.createElement('li');
      prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
      prevLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>`;
      pagination.appendChild(prevLi);
      
      // Page numbers
      const maxVisiblePages = 5;
      let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
      let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
      
      if (endPage - startPage + 1 < maxVisiblePages) {
        startPage = Math.max(1, endPage - maxVisiblePages + 1);
      }
      
      if (startPage > 1) {
        const firstLi = document.createElement('li');
        firstLi.className = 'page-item';
        firstLi.innerHTML = `<a class="page-link" href="#" data-page="1">1</a>`;
        pagination.appendChild(firstLi);
        
        if (startPage > 2) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
      }
      
      for (let i = startPage; i <= endPage; i++) {
        const pageLi = document.createElement('li');
        pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
        pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
        pagination.appendChild(pageLi);
      }
      
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          const ellipsisLi = document.createElement('li');
          ellipsisLi.className = 'page-item disabled';
          ellipsisLi.innerHTML = `<span class="page-link">...</span>`;
          pagination.appendChild(ellipsisLi);
        }
        
        const lastLi = document.createElement('li');
        lastLi.className = 'page-item';
        lastLi.innerHTML = `<a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a>`;
        pagination.appendChild(lastLi);
      }
      
      // Next button
      const nextLi = document.createElement('li');
      nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
      nextLi.innerHTML = `<a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>`;
      pagination.appendChild(nextLi);
    }

    function addUserRow(user, userId) {
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td>
          <div class="d-flex align-items-center">
            <img src="${user.photoURL || 'https://via.placeholder.com/40?text=User'}" class="user-avatar" alt="${user.name || 'User'}">
            <div>
              <div class="fw-bold">${user.name || 'No name'}</div>
              <div class="text-muted small">${user.phone || 'No phone'}</div>
            </div>
          </div>
        </td>
        <td>${user.email || 'N/A'}</td>
        <td>${user.createdAt?.toDate().toLocaleDateString() || 'N/A'}</td>
        <td>${user.totalBookings || 0}</td>
        <td>
          <span class="status-badge ${user.isBlocked ? 'bg-danger' : 'bg-success'}">
            ${user.isBlocked ? 'Blocked' : 'Active'}
          </span>
        </td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-outline-primary view-user" data-user-id="${userId}">
            <i class="fas fa-eye"></i>
          </button>
          ${!user.isBlocked ? `
            <button class="btn btn-sm btn-outline-danger block-user" data-user-id="${userId}">
              <i class="fas fa-ban"></i>
            </button>
          ` : `
            <button class="btn btn-sm btn-outline-success unblock-user" data-user-id="${userId}">
              <i class="fas fa-check-circle"></i>
            </button>
          `}
        </td>
      `;
      
      document.getElementById('usersList').appendChild(row);
    }

    // Load offers
    function loadOffers() {
      db.collection('offers').orderBy('createdAt', 'desc').get().then(snap => {
        const offersList = document.getElementById('offersList');
        offersList.innerHTML = '';
        
        if (snap.empty) {
          offersList.innerHTML = `
            <tr>
              <td colspan="6" class="text-center py-5"><h6 class="text-muted">No offers found</h6></td>
            </tr>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const offer = doc.data();
          addOfferRow(offer, doc.id);
        });
      }).catch(error => {
        console.error("Error loading offers:", error);
        document.getElementById('offersList').innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-5 text-danger">Error loading offers</td>
          </tr>
        `;
      });
    }

    function addOfferRow(offer, offerId) {
      const row = document.createElement('tr');
      
      row.innerHTML = `
        <td class="fw-bold">${offer.code || 'N/A'}</td>
        <td>${offer.name || 'N/A'}</td>
        <td>
          ${offer.discountType === 'percentage' ? 
            `${offer.discountValue || 0}%` : 
            `â‚¹${offer.discountValue || 0}`}
        </td>
        <td>${offer.validUntil ? new Date(offer.validUntil).toLocaleDateString() : 'N/A'}</td>
        <td>
          <span class="status-badge ${offer.isActive ? 'bg-success' : 'bg-secondary'}">
            ${offer.isActive ? 'Active' : 'Inactive'}
          </span>
        </td>
        <td class="action-buttons">
          <button class="btn btn-sm btn-outline-primary toggle-offer" 
                  data-offer-id="${offerId}" 
                  data-current-status="${offer.isActive}">
            ${offer.isActive ? 'Deactivate' : 'Activate'}
          </button>
          <button class="btn btn-sm btn-outline-danger delete-offer" 
                  data-offer-id="${offerId}">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;

      document.getElementById('offersList').appendChild(row);
    }

    // Load cars
    function loadCars() {
      db.collection('cars').orderBy('createdAt', 'desc').get().then(snap => {
        const carsGrid = document.getElementById('carsGrid');
        carsGrid.innerHTML = '';
        
        if (snap.empty) {
          carsGrid.innerHTML = `
            <div class="col-12 text-center py-5">
              <h6 class="text-muted">No cars found</h6>
            </div>
          `;
          return;
        }
        
        snap.forEach(doc => {
          const car = doc.data();
          addCarCard(car, doc.id);
        });
      }).catch(error => {
        console.error("Error loading cars:", error);
        document.getElementById('carsGrid').innerHTML = `
          <div class="col-12 text-center py-5 text-danger">
            Error loading cars
          </div>
        `;
      });
    }

    function addCarCard(car, carId) {
      const col = document.createElement('div');
      col.className = 'col-md-4 mb-4';
      
      col.innerHTML = `
        <div class="card h-100 shadow-sm">
          <img src="${car.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" class="card-img-top" alt="${car.name}" 
               onerror="this.onerror=null;this.src='https://via.placeholder.com/300x200?text=No+Image'">
          <div class="card-body">
            <h5 class="card-title">${car.name || 'Unnamed Car'}</h5>
            <p class="card-text text-muted">${car.category ? car.category.toUpperCase() : 'N/A'}</p>
            <p class="card-text">${car.description ? car.description.substring(0, 100) + (car.description.length > 100 ? '...' : '') : 'No description'}</p>
            <div class="d-flex justify-content-between">
              <div>
                <span class="badge bg-light text-dark me-2">12h: â‚¹${car.price12hrs || '0'}</span>
                <span class="badge bg-light text-dark">24h: â‚¹${car.price24hrs || '0'}</span>
              </div>
              <div>
                ${car.sunroof ? '<span class="badge bg-info car-feature-badge">Sunroof</span>' : ''}
                ${car.withDriver ? '<span class="badge bg-warning car-feature-badge">With Driver</span>' : ''}
                ${car.transmission === 'automatic' ? '<span class="badge bg-primary car-feature-badge">Automatic</span>' : ''}
                ${car.transmission === 'manual' ? '<span class="badge bg-secondary car-feature-badge">Manual</span>' : ''}
              </div>
            </div>
          </div>
          <div class="card-footer bg-white d-flex justify-content-between">
            <button class="btn btn-sm btn-outline-primary edit-car" data-car-id="${carId}">
              <i class="fas fa-edit me-1"></i> Edit
            </button>
            <button class="btn btn-sm btn-outline-danger delete-car" data-car-id="${carId}">
              <i class="fas fa-trash me-1"></i> Delete
            </button>
          </div>
        </div>
      `;
      
      document.getElementById('carsGrid').appendChild(col);
    }

    // Helper function to get status badge class
    function getStatusBadgeClass(status) {
      switch(status) {
        case 'confirmed':
        case 'active':
        case 'completed':
          return 'bg-success';
        case 'pending_payment':
          return 'bg-warning text-dark';
        case 'awaiting_verification':
          return 'bg-info';
        case 'cancelled':
          return 'bg-danger';
        default:
          return 'bg-secondary';
      }
    }

    // Helper function to format date
    function formatDate(date) {
      if (!date) return 'N/A';
      if (date.toDate) {
        return date.toDate().toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      return new Date(date).toLocaleDateString('en-US', { 
        month: 'short', 
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Setup event listeners
    function setupEventListeners() {
      // Navigation
      document.querySelectorAll('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Update active nav link
          document.querySelectorAll('.nav-link').forEach(navLink => {
            navLink.classList.remove('active');
          });
          this.classList.add('active');
          
          // Show corresponding section
          const target = this.getAttribute('data-target');
          dashboardSection.style.display = 'none';
          bookingsSection.style.display = 'none';
          usersSection.style.display = 'none';
          offersSection.style.display = 'none';
          carsSection.style.display = 'none';
          
          switch(target) {
            case 'dashboard':
              dashboardSection.style.display = 'block';
              loadDashboard();
              break;
            case 'bookings':
              bookingsSection.style.display = 'block';
              loadAllBookings();
              break;
            case 'users':
              usersSection.style.display = 'block';
              loadUsers();
              break;
            case 'offers':
              offersSection.style.display = 'block';
              loadOffers();
              break;
            case 'cars':
              carsSection.style.display = 'block';
              loadCars();
              break;
          }
        });
      });

      // Logout
      logoutBtn.addEventListener('click', () => {
        auth.signOut().then(() => {
          window.location.href = 'login.html';
        });
      });

      // View all bookings
      viewAllBookings.addEventListener('click', (e) => {
        e.preventDefault();
        document.querySelector('.nav-link[data-target="bookings"]').click();
      });

      // Booking filters
      document.querySelectorAll('.filter-booking').forEach(filter => {
        filter.addEventListener('click', (e) => {
          e.preventDefault();
          const status = filter.getAttribute('data-status');
          
          // Update active filter
          document.querySelectorAll('.filter-booking').forEach(f => {
            f.classList.remove('active');
          });
          filter.classList.add('active');
          
          loadAllBookings(1, status, currentBookingsSearch);
        });
      });

      // User filters
      document.querySelectorAll('.filter-user').forEach(filter => {
        filter.addEventListener('click', (e) => {
          e.preventDefault();
          const status = filter.getAttribute('data-status');
          
          // Update active filter
          document.querySelectorAll('.filter-user').forEach(f => {
            f.classList.remove('active');
          });
          filter.classList.add('active');
          
          loadUsers(1, status, currentUsersSearch);
        });
      });

      // Booking search
      document.getElementById('bookingSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.trim();
        loadAllBookings(1, currentBookingsFilter, searchTerm);
      });

      // User search
      document.getElementById('userSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.trim();
        loadUsers(1, currentUsersFilter, searchTerm);
      });

      // Pagination click handlers
      document.addEventListener('click', (e) => {
        if (e.target.closest('.page-link')) {
          e.preventDefault();
          const page = parseInt(e.target.getAttribute('data-page'));
          
          if (e.target.closest('#bookingsPagination')) {
            loadAllBookings(page, currentBookingsFilter, currentBookingsSearch);
          } else if (e.target.closest('#usersPagination')) {
            loadUsers(page, currentUsersFilter, currentUsersSearch);
          }
        }
      });

      // View booking details
      document.addEventListener('click', (e) => {
        if (e.target.closest('.view-booking')) {
          const bookingId = e.target.closest('.view-booking').getAttribute('data-booking-id');
          viewBookingDetails(bookingId);
        }
        
        // Confirm booking
        if (e.target.closest('.confirm-booking')) {
          const bookingId = e.target.closest('.confirm-booking').getAttribute('data-booking-id');
          confirmBooking(bookingId);
        }
        
        // Verify payment
        if (e.target.closest('.verify-payment')) {
          const bookingId = e.target.closest('.verify-payment').getAttribute('data-booking-id');
          showVerifyPaymentModal(bookingId);
        }
        
        // Cancel booking
        if (e.target.closest('.cancel-booking')) {
          const bookingId = e.target.closest('.cancel-booking').getAttribute('data-booking-id');
          cancelBooking(bookingId);
        }
        
        // View user details
        if (e.target.closest('.view-user')) {
          const userId = e.target.closest('.view-user').getAttribute('data-user-id');
          viewUserDetails(userId);
        }
        
        // Block user
        if (e.target.closest('.block-user')) {
          const userId = e.target.closest('.block-user').getAttribute('data-user-id');
          blockUser(userId);
        }
        
        // Unblock user
        if (e.target.closest('.unblock-user')) {
          const userId = e.target.closest('.unblock-user').getAttribute('data-user-id');
          unblockUser(userId);
        }
        
        // Toggle offer status
        if (e.target.closest('.toggle-offer')) {
          const offerId = e.target.closest('.toggle-offer').getAttribute('data-offer-id');
          const currentStatus = e.target.closest('.toggle-offer').getAttribute('data-current-status') === 'true';
          toggleOfferStatus(offerId, !currentStatus);
        }
        
        // Delete offer
        if (e.target.closest('.delete-offer')) {
          const offerId = e.target.closest('.delete-offer').getAttribute('data-offer-id');
          deleteOffer(offerId);
        }
        
        // Edit car
        if (e.target.closest('.edit-car')) {
          const carId = e.target.closest('.edit-car').getAttribute('data-car-id');
          editCar(carId);
        }
        
        // Delete car
        if (e.target.closest('.delete-car')) {
          const carId = e.target.closest('.delete-car').getAttribute('data-car-id');
          deleteCar(carId);
        }
      });

      // Save new offer
      document.getElementById('saveOfferBtn').addEventListener('click', () => {
        saveNewOffer();
      });

      // Save new car
      document.getElementById('saveCarBtn').addEventListener('click', () => {
        saveNewCar();
      });

      // Confirm booking from modal
      document.getElementById('confirmBookingBtn').addEventListener('click', () => {
        if (currentBookingId) {
          confirmBooking(currentBookingId);
          bookingModal.hide();
        }
      });

      // Cancel booking from modal
      document.getElementById('cancelBookingBtn').addEventListener('click', () => {
        if (currentBookingId) {
          cancelBooking(currentBookingId);
          bookingModal.hide();
        }
      });

      // Verify payment from modal
      document.getElementById('verifyPaymentBtn').addEventListener('click', () => {
        if (currentBookingId) {
          showVerifyPaymentModal(currentBookingId);
          bookingModal.hide();
        }
      });

      // Submit verification
      document.getElementById('submitVerificationBtn').addEventListener('click', () => {
        submitVerification();
      });

      // Block user from modal
      document.getElementById('blockUserBtn').addEventListener('click', () => {
        if (currentUserId) {
          blockUser(currentUserId);
          userModal.hide();
        }
      });

      // Unblock user from modal
      document.getElementById('unblockUserBtn').addEventListener('click', () => {
        if (currentUserId) {
          unblockUser(currentUserId);
          userModal.hide();
        }
      });
    }

    // View booking details
    async function viewBookingDetails(bookingId) {
      currentBookingId = bookingId;
      
      try {
        const doc = await db.collection('bookings').doc(bookingId).get();
        if (!doc.exists) {
          alert('Booking not found');
          return;
        }
        
        const booking = doc.data();
        const modalBody = document.getElementById('bookingModalBody');
        
        // Format dates
        const startDate = booking.startDateTime.toDate();
        const endDate = booking.endDateTime.toDate();
        const createdAt = booking.createdAt.toDate();
        
        modalBody.innerHTML = `
          <div class="row">
            <div class="col-md-6">
              <h6 class="text-muted">Booking Information</h6>
              <p><strong>Booking ID:</strong> ${bookingId}</p>
              <p><strong>Status:</strong> <span class="status-badge ${getStatusBadgeClass(booking.status)}">${booking.status.replace('_', ' ')}</span></p>
              <p><strong>Created At:</strong> ${createdAt.toLocaleString()}</p>
              <p><strong>Dates:</strong> ${startDate.toLocaleString()} to ${endDate.toLocaleString()}</p>
              <p><strong>Duration:</strong> ${calculateDuration(startDate, endDate)}</p>
              ${booking.pickupLocation ? `<p><strong>Pickup Location:</strong> ${booking.pickupLocation}</p>` : ''}
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Car Information</h6>
              <div class="d-flex mb-3">
                <img src="${booking.carImage || 'https://via.placeholder.com/100?text=Car'}" 
                     class="img-thumbnail me-3" style="width: 100px; height: auto;">
                <div>
                  <h5>${booking.carName || 'N/A'}</h5>
                  <p class="text-muted mb-1">${booking.carCategory ? booking.carCategory.toUpperCase() : 'N/A'}</p>
                  ${booking.carWithDriver ? '<span class="badge bg-warning me-1">With Driver</span>' : ''}
                </div>
              </div>
              <p><strong>Original Price:</strong> â‚¹${booking.originalPrice || '0'}</p>
              ${booking.discountApplied ? `
                <p><strong>Discount Applied:</strong> ${booking.discountCode || ''} (â‚¹${booking.discountAmount || '0'})</p>
              ` : ''}
              <p><strong>Final Price:</strong> â‚¹${booking.finalPrice || booking.originalPrice || '0'}</p>
            </div>
          </div>
          <div class="row mt-3">
            <div class="col-md-6">
              <h6 class="text-muted">Customer Information</h6>
              <div class="d-flex mb-3">
                <img src="${booking.userPhotoURL || 'https://via.placeholder.com/50?text=User'}" 
                     class="rounded-circle me-3" style="width: 50px; height: 50px;">
                <div>
                  <h5>${booking.userName || 'Not specified'}</h5>
                  <p class="text-muted mb-1">${booking.userEmail || 'N/A'}</p>
                  <p class="text-muted mb-0">${booking.userPhone || 'Not specified'}</p>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <h6 class="text-muted">Payment Information</h6>
              <p><strong>Payment Method:</strong> ${booking.paymentMethod || 'Not specified'}</p>
              <p><strong>Payment Status:</strong> ${booking.paymentStatus || 'Pending'}</p>
              ${booking.transactionId ? `<p><strong>Transaction ID:</strong> ${booking.transactionId}</p>` : ''}
              ${booking.paymentDetails ? `
                <div class="mt-3">
                  <h6>Payment Details</h6>
                  <p><strong>Amount:</strong> â‚¹${booking.paymentDetails.amount || '0'}</p>
                  <p><strong>Date:</strong> ${new Date(booking.paymentDetails.date).toLocaleDateString()}</p>
                  ${booking.paymentDetails.screenshotUrl ? `
                    <a href="${booking.paymentDetails.screenshotUrl}" target="_blank" class="btn btn-sm btn-outline-primary">
                      View Payment Proof
                    </a>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          </div>
        `;
        
        // Show appropriate action buttons
        document.getElementById('cancelBookingBtn').style.display = 'none';
        document.getElementById('confirmBookingBtn').style.display = 'none';
        document.getElementById('verifyPaymentBtn').style.display = 'none';
        
        if (booking.status === 'pending_payment') {
          document.getElementById('confirmBookingBtn').style.display = 'inline-block';
          document.getElementById('cancelBookingBtn').style.display = 'inline-block';
        } else if (booking.status === 'awaiting_verification') {
          document.getElementById('verifyPaymentBtn').style.display = 'inline-block';
          document.getElementById('cancelBookingBtn').style.display = 'inline-block';
        }
        
        bookingModal.show();
      } catch (error) {
        console.error("Error loading booking details:", error);
        document.getElementById('bookingModalBody').innerHTML = `
          <div class="alert alert-danger">
            Error loading booking details
          </div>
        `;
      }
    }

    // Calculate duration between two dates
    function calculateDuration(startDate, endDate) {
      const diff = endDate - startDate;
      const hours = Math.floor(diff / (1000 * 60 * 60));
      const days = Math.floor(hours / 24);
      const remainingHours = hours % 24;
      
      let duration = '';
      if (days > 0) {
        duration += `${days} day${days > 1 ? 's' : ''} `;
      }
      if (remainingHours > 0) {
        duration += `${remainingHours} hour${remainingHours > 1 ? 's' : ''}`;
      }
      
      return duration || 'Less than 1 hour';
    }

    // View user details
    async function viewUserDetails(userId) {
      currentUserId = userId;
      
      try {
        const doc = await db.collection('users').doc(userId).get();
        if (!doc.exists) {
          alert('User not found');
          return;
        }
        
        const user = doc.data();
        const modalBody = document.getElementById('userModalBody');
        
        // Get user's bookings
        const bookingsQuery = await db.collection('bookings')
          .where('userId', '==', userId)
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();
        
        let bookingsHtml = '';
        if (bookingsQuery.empty) {
          bookingsHtml = '<p class="text-muted">No bookings found</p>';
        } else {
          bookingsHtml = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Booking ID</th><th>Car</th><th>Date</th><th>Status</th><th>Amount</th></tr></thead><tbody>';
          
          bookingsQuery.forEach(bookingDoc => {
            const booking = bookingDoc.data();
            bookingsHtml += `
              <tr>
                <td>${bookingDoc.id.substring(0, 8)}</td>
                <td>${booking.carName || 'N/A'}</td>
                <td>${formatDate(booking.startDateTime)}</td>
                <td><span class="status-badge ${getStatusBadgeClass(booking.status)}">${booking.status.replace('_', ' ')}</span></td>
                <td>â‚¹${booking.finalPrice || '0'}</td>
              </tr>
            `;
          });
          
          bookingsHtml += '</tbody></table></div>';
        }
        
        modalBody.innerHTML = `
          <div class="row">
            <div class="col-md-4 text-center mb-4">
              <img src="${user.photoURL || 'https://via.placeholder.com/150?text=User'}" 
                   class="rounded-circle img-thumbnail mb-3" style="width: 150px; height: 150px;">
              <h4>${user.name || 'No name'}</h4>
              <p class="text-muted">${user.email || 'N/A'}</p>
              <span class="status-badge ${user.isBlocked ? 'bg-danger' : 'bg-success'}">
                ${user.isBlocked ? 'Blocked' : 'Active'}
              </span>
            </div>
            <div class="col-md-8">
              <h6 class="text-muted">Basic Information</h6>
              <div class="row mb-3">
                <div class="col-md-6">
                  <p><strong>Phone:</strong> ${user.phone || 'Not provided'}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>Joined:</strong> ${user.createdAt?.toDate().toLocaleDateString() || 'N/A'}</p>
                </div>
              </div>
              
              <h6 class="text-muted mt-4">Additional Information</h6>
              <div class="row mb-3">
                <div class="col-md-6">
                  <p><strong>Address:</strong> ${user.address || 'Not provided'}</p>
                </div>
                <div class="col-md-6">
                  <p><strong>License Number:</strong> ${user.driverLicense || 'Not provided'}</p>
                </div>
              </div>
              
              <h6 class="text-muted mt-4">Recent Bookings</h6>
              ${bookingsHtml}
            </div>
          </div>
        `;
        
        // Show appropriate action buttons
        document.getElementById('blockUserBtn').style.display = 'none';
        document.getElementById('unblockUserBtn').style.display = 'none';
        
        if (user.isBlocked) {
          document.getElementById('unblockUserBtn').style.display = 'inline-block';
        } else {
          document.getElementById('blockUserBtn').style.display = 'inline-block';
        }
        
        userModal.show();
      } catch (error) {
        console.error("Error loading user details:", error);
        document.getElementById('userModalBody').innerHTML = `
          <div class="alert alert-danger">
            Error loading user details
          </div>
        `;
      }
    }

    // Show verify payment modal
    async function showVerifyPaymentModal(bookingId) {
      currentBookingId = bookingId;
      
      try {
        const doc = await db.collection('bookings').doc(bookingId).get();
        if (!doc.exists) {
          alert('Booking not found');
          return;
        }
        
        const booking = doc.data();
        
        // Set default values in form
        document.getElementById('verificationStatus').value = 'verified';
        document.getElementById('verificationNotes').value = '';
        
        verifyPaymentModal.show();
      } catch (error) {
        console.error("Error loading booking for verification:", error);
        alert('Error loading booking details');
      }
    }

    // Submit payment verification
    async function submitVerification() {
      const status = document.getElementById('verificationStatus').value;
      const notes = document.getElementById('verificationNotes').value;
      
      if (!currentBookingId) {
        alert('No booking selected');
        return;
      }
      
      const btn = document.getElementById('submitVerificationBtn');
      const submitText = btn.querySelector('.submit-text');
      const spinner = btn.querySelector('.spinner-border');
      
      // Set loading state
      submitText.textContent = 'Submitting...';
      spinner.classList.remove('d-none');
      btn.disabled = true;
      
      try {
        const updateData = {
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          'paymentDetails.verified': status === 'verified',
          'paymentDetails.verifiedBy': auth.currentUser.email,
          'paymentDetails.verifiedAt': firebase.firestore.FieldValue.serverTimestamp(),
          'paymentDetails.notes': notes
        };
        
        if (status === 'verified') {
          updateData.status = 'confirmed';
          updateData.paymentStatus = 'paid';
        } else {
          updateData.status = 'pending_payment';
        }
        
        await db.collection('bookings').doc(currentBookingId).update(updateData);
        
        verifyPaymentModal.hide();
        alert('Payment verification submitted successfully');
        
        // Refresh data
        if (bookingsSection.style.display !== 'none') {
          loadAllBookings(currentBookingsPage, currentBookingsFilter, currentBookingsSearch);
        }
        if (dashboardSection.style.display !== 'none') {
          loadDashboard();
        }
      } catch (error) {
        console.error("Error submitting verification:", error);
        alert('Failed to submit verification');
      } finally {
        // Reset button state
        submitText.textContent = 'Submit Verification';
        spinner.classList.add('d-none');
        btn.disabled = false;
      }
    }

    // Confirm booking
    function confirmBooking(bookingId) {
      if (!confirm('Are you sure you want to confirm this booking?')) return;
      
      const btn = document.getElementById('confirmBookingBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
      btn.disabled = true;
      
      db.collection('bookings').doc(bookingId).update({
        status: 'confirmed',
        paymentStatus: 'paid',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Booking confirmed successfully');
        if (bookingsSection.style.display !== 'none') {
          loadAllBookings(currentBookingsPage, currentBookingsFilter, currentBookingsSearch);
        }
        if (dashboardSection.style.display !== 'none') {
          loadDashboard();
        }
      })
      .catch(error => {
        console.error("Error confirming booking:", error);
        alert('Failed to confirm booking');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Cancel booking
    function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;
      
      const btn = document.getElementById('cancelBookingBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
      btn.disabled = true;
      
      db.collection('bookings').doc(bookingId).update({
        status: 'cancelled',
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('Booking cancelled successfully');
        if (bookingsSection.style.display !== 'none') {
          loadAllBookings(currentBookingsPage, currentBookingsFilter, currentBookingsSearch);
        }
        if (dashboardSection.style.display !== 'none') {
          loadDashboard();
        }
      })
      .catch(error => {
        console.error("Error cancelling booking:", error);
        alert('Failed to cancel booking');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Block user
    function blockUser(userId) {
      if (!confirm('Are you sure you want to block this user? They will not be able to make new bookings.')) return;
      
      const btn = document.getElementById('blockUserBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
      btn.disabled = true;
      
      db.collection('users').doc(userId).update({
        isBlocked: true,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User blocked successfully');
        if (usersSection.style.display !== 'none') {
          loadUsers(currentUsersPage, currentUsersFilter, currentUsersSearch);
        }
      })
      .catch(error => {
        console.error("Error blocking user:", error);
        alert('Failed to block user');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Unblock user
    function unblockUser(userId) {
      if (!confirm('Are you sure you want to unblock this user? They will be able to make new bookings.')) return;
      
      const btn = document.getElementById('unblockUserBtn');
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
      btn.disabled = true;
      
      db.collection('users').doc(userId).update({
        isBlocked: false,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        alert('User unblocked successfully');
        if (usersSection.style.display !== 'none') {
          loadUsers(currentUsersPage, currentUsersFilter, currentUsersSearch);
        }
      })
      .catch(error => {
        console.error("Error unblocking user:", error);
        alert('Failed to unblock user');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Toggle offer status
    function toggleOfferStatus(offerId, newStatus) {
      const btn = document.querySelector(`.toggle-offer[data-offer-id="${offerId}"]`);
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
      btn.disabled = true;
      
      db.collection('offers').doc(offerId).update({
        isActive: newStatus,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      })
      .then(() => {
        loadOffers();
      })
      .catch(error => {
        console.error("Error toggling offer status:", error);
        alert('Failed to update offer status');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Delete offer
    function deleteOffer(offerId) {
      if (!confirm('Are you sure you want to delete this offer? This cannot be undone.')) return;
      
      const btn = document.querySelector(`.delete-offer[data-offer-id="${offerId}"]`);
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
      btn.disabled = true;
      
      db.collection('offers').doc(offerId).delete()
      .then(() => {
        loadOffers();
      })
      .catch(error => {
        console.error("Error deleting offer:", error);
        alert('Failed to delete offer');
      })
      .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
      });
    }

    // Save new offer
    function saveNewOffer() {
      const offerCode = document.getElementById('offerCode').value.trim();
      const offerName = document.getElementById('offerName').value.trim();
      const offerDescription = document.getElementById('offerDescription').value.trim();
      const discountType = document.getElementById('discountType').value;
      const discountValue = parseFloat(document.getElementById('discountValue').value);
      const validUntil = document.getElementById('validUntil').value;
      const isActive = document.getElementById('isActive').checked;
      
      // Validate inputs
      if (!offerCode || !offerName || isNaN(discountValue) || !validUntil) {
        alert('Please fill all required fields');
        return;
      }
      
      if (discountValue <= 0) {
        alert('Discount value must be greater than 0');
        return;
      }
      
      if (discountType === 'percentage' && discountValue > 100) {
        alert('Percentage discount cannot be more than 100%');
        return;
      }
      
      const btn = document.getElementById('saveOfferBtn');
      const submitText = btn.querySelector('.submit-text');
      const spinner = btn.querySelector('.spinner-border');
      
      // Set loading state
      submitText.textContent = 'Saving...';
      spinner.classList.remove('d-none');
      btn.disabled = true;
      
      const newOffer = {
        code: offerCode,
        name: offerName,
        description: offerDescription,
        discountType,
        discountValue,
        validUntil: new Date(validUntil),
        isActive,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection('offers').add(newOffer)
        .then(() => {
          alert('Offer created successfully');
          addOfferModal.hide();
          document.getElementById('offerForm').reset();
          loadOffers();
        })
        .catch(error => {
          console.error("Error adding offer:", error);
          alert('Failed to create offer');
        })
        .finally(() => {
          submitText.textContent = 'Save Offer';
          spinner.classList.add('d-none');
          btn.disabled = false;
        });
    }

    // Save new car
    function saveNewCar() {
      const carName = document.getElementById('carName').value.trim();
      const carImage = document.getElementById('carImage').value.trim();
      const carDescription = document.getElementById('carDescription').value.trim();
      const carCategory = document.getElementById('carCategory').value;
      const carPrice12hrs = parseFloat(document.getElementById('carPrice12hrs').value);
      const carPrice24hrs = parseFloat(document.getElementById('carPrice24hrs').value);
      const carSunroof = document.getElementById('carSunroof').checked;
      const carWithDriver = document.getElementById('carWithDriver').checked;
      const carTransmission = document.getElementById('carTransmission').value;
      
      // Validate inputs
      if (!carName || !carImage || !carDescription || isNaN(carPrice12hrs) || isNaN(carPrice24hrs)) {
        alert('Please fill all required fields');
        return;
      }
      
      if (carPrice12hrs <= 0 || carPrice24hrs <= 0) {
        alert('Prices must be greater than 0');
        return;
      }
      
      const btn = document.getElementById('saveCarBtn');
      const submitText = btn.querySelector('.submit-text');
      const spinner = btn.querySelector('.spinner-border');
      
      // Set loading state
      submitText.textContent = 'Saving...';
      spinner.classList.remove('d-none');
      btn.disabled = true;
      
      const newCar = {
        name: carName,
        imageUrl: carImage,
        description: carDescription,
        category: carCategory,
        price12hrs: carPrice12hrs,
        price24hrs: carPrice24hrs,
        sunroof: carSunroof,
        withDriver: carWithDriver,
        transmission: carTransmission,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      db.collection('cars').add(newCar)
        .then(() => {
          alert('Car added successfully');
          addCarModal.hide();
          document.getElementById('carForm').reset();
          loadCars();
        })
        .catch(error => {
          console.error("Error adding car:", error);
          alert('Failed to add car');
        })
        .finally(() => {
          submitText.textContent = 'Save Car';
          spinner.classList.add('d-none');
          btn.disabled = false;
        });
    }

    // Edit car
    function editCar(carId) {
      // This would require fetching car details and populating the add car modal
      // Then changing the save button to update instead of create
      alert('Edit car functionality would be implemented here');
    }

    // Delete car
    function deleteCar(carId) {
      if (!confirm('Are you sure you want to delete this car? This cannot be undone.')) return;
      
      const btn = document.querySelector(`.delete-car[data-car-id="${carId}"]`);
      const originalText = btn.innerHTML;
      btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
      btn.disabled = true;
      
      db.collection('cars').doc(carId).delete()
        .then(() => {
          loadCars();
        })
        .catch(error => {
          console.error("Error deleting car:", error);
          alert('Failed to delete car');
        })
        .finally(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        });
    }
  </script>
</body>
</html>
